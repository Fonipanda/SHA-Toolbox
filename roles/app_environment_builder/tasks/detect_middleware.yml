---

- name: "Initialisation de la liste des middlewares et services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_middlewares: []
    detected_services: []
    detected_packages: []
    middleware_to_configure: []  # Pour configuration/upgrade via rÃ´les toolbox
    users_to_create: []

# ===== DÃ‰TECTION MIDDLEWARES (Serveurs d'Applications + Bases de DonnÃ©es + Messaging) =====

# ===== DÃ‰TECTION AMÃ‰LIORÃ‰E WEBSPHERE VIA SCRIPT PYTHON =====
- name: "Copie du script de dÃ©tection WebSphere"
  ansible.builtin.copy:
    src: websphere_manager.py
    dest: /tmp/websphere_manager.py
    mode: '0755'
  when: ansible_os_family == "RedHat"

- name: "ExÃ©cution du script de dÃ©tection WebSphere"
  ansible.builtin.command: python3 /tmp/websphere_manager.py
  register: websphere_detection_output
  changed_when: false
  failed_when: false
  when: ansible_os_family == "RedHat"

- name: "Enregistrement du produit WebSphere dÃ©tectÃ©"
  ansible.builtin.set_fact:
    websphere_product_detected: "{{ websphere_detection_output.stdout | default('None') }}"
  when: 
    - ansible_os_family == "RedHat"
    - websphere_detection_output is defined

- name: "Affichage du produit WebSphere dÃ©tectÃ© par script Python"
  ansible.builtin.debug:
    msg: "Produit WebSphere dÃ©tectÃ© via script: {{ websphere_product_detected | default('None') }}"

# ===== DÃ‰TECTION WEBSERVER / WAS ND =====
- name: "DÃ©tection WebSphere Application Server (WAS ND)"
  block:
    - name: "VÃ©rification des rÃ©pertoires WAS WASND"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/WebSphere/AppServer
        - /usr/IBM/WebSphere/AppServer
      register: was_dir_check

    - name: "VÃ©rification processus WAS"
      ansible.builtin.shell: |
        pgrep -f "dmgr|nodeagent|server1" | wc -l
      register: was_process_check
      changed_when: false
      failed_when: false

    - name: "Extraction de la version WAS si prÃ©sent"
      ansible.builtin.shell: |
        grep "PRODUCT_VERSION" /opt/IBM/WebSphere/AppServer/properties/version/BASE.product 2>/dev/null | cut -d= -f2 || echo "N/A"
      register: was_version
      changed_when: false
      failed_when: false
      when: was_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de WAS ND Ã  la liste des MIDDLEWARES dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'WebSphere_WASND', 'type': 'application_server', 'path': '/opt/IBM/WebSphere/AppServer', 'version': was_version.stdout | default('N/A'), 'status': 'installed', 'processes': was_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['wasnd'] }}"
        users_to_create: "{{ users_to_create + ['wasadmin'] }}"
      when: 
        - was_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

# ===== DÃ‰TECTION WASBASE =====
- name: "DÃ©tection WebSphere Application Server (WAS Base)"
  block:
    - name: "VÃ©rification WAS Base (sans ND)"
      ansible.builtin.stat:
        path: /opt/IBM/WebSphere/AppServer
      register: wasbase_check

    - name: "VÃ©rification absence ND"
      ansible.builtin.shell: |
        test ! -d /opt/IBM/WebSphere/AppServer/profiles/Dmgr01 && echo "BASE" || echo "ND"
      register: wasbase_type
      changed_when: false
      failed_when: false
      when: wasbase_check.stat.exists

    - name: "Ajout de WAS Base Ã  la liste des MIDDLEWARES dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'WebSphere_WASBASE', 'type': 'application_server', 'path': '/opt/IBM/WebSphere/AppServer', 'version': was_version.stdout | default('N/A'), 'status': 'installed', 'processes': 1}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['wasbase'] }}"
      when:
        - wasbase_check.stat.exists
        - wasbase_type.stdout == "BASE"

# ===== DÃ‰TECTION LIBERTY =====
- name: "DÃ©tection WebSphere Liberty"
  block:
    - name: "VÃ©rification des rÃ©pertoires Liberty"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/WebSphere/Liberty
        - /usr/IBM/WebSphere/Liberty
        - /opt/wlp
      register: liberty_dir_check

    - name: "VÃ©rification processus Liberty"
      ansible.builtin.shell: |
        pgrep -f "java.*liberty" | wc -l
      register: liberty_process_check
      changed_when: false
      failed_when: false

    - name: "Extraction de la version Liberty si prÃ©sent"
      ansible.builtin.shell: |
        /opt/IBM/WebSphere/Liberty/bin/productInfo version 2>/dev/null | grep "Product name" | cut -d: -f2 || echo "Liberty"
      register: liberty_version
      changed_when: false
      failed_when: false
      when: liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "DÃ©tection type Liberty (Core ou Base)"
      ansible.builtin.shell: |
        if [ -f /opt/IBM/WebSphere/Liberty/lib/features/appSecurity-*.jar ]; then
          echo "Liberty_Base"
        else
          echo "Liberty_Core"
        fi
      register: liberty_type
      changed_when: false
      failed_when: false
      when: liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de Liberty Ã  la liste des MIDDLEWARES dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': liberty_type.stdout | default('Liberty_Core'), 'type': 'application_server', 'path': '/opt/IBM/WebSphere/Liberty', 'version': liberty_version.stdout | default('N/A'), 'status': 'installed', 'processes': liberty_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['liberty'] }}"
        users_to_create: "{{ users_to_create + ['liberty'] }}"
      when: 
        - liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

# ===== DÃ‰TECTION ORACLE =====
- name: "DÃ©tection Oracle Database"
  block:
    - name: "VÃ©rification du fichier oratab"
      ansible.builtin.stat:
        path: /etc/oratab
      register: oratab_check

    - name: "VÃ©rification du processus Oracle PMON"
      ansible.builtin.shell: |
        pgrep -f "ora_pmon" | wc -l
      register: oracle_process_check
      changed_when: false
      failed_when: false

    - name: "VÃ©rification du rÃ©pertoire Oracle ORACLE_HOME"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /u01/app/oracle/product
        - /opt/oracle/product
      register: oracle_dir_check

    - name: "RÃ©cupÃ©ration version Oracle"
      ansible.builtin.shell: |
        cat /etc/oratab | grep -v "^#" | grep -v "^$" | head -1 | cut -d: -f2 | xargs basename || echo "N/A"
      register: oracle_version
      changed_when: false
      failed_when: false
      when: oratab_check.stat.exists

    - name: "Ajout d'Oracle Ã  la liste des MIDDLEWARES dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'Oracle_Database', 'type': 'database', 'path': '/u01/app/oracle', 'version': oracle_version.stdout | default('N/A'), 'status': 'installed', 'processes': oracle_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['oracle'] }}"
        users_to_create: "{{ users_to_create + ['oracle'] }}"
      when:
        - oratab_check.stat.exists
        - (oracle_process_check.stdout | int) > 0

# ===== DÃ‰TECTION SQL SERVER =====
- name: "DÃ©tection SQL Server"
  block:
    - name: "VÃ©rification service SQL Server"
      ansible.builtin.shell: |
        pgrep -f "sqlservr" | wc -l
      register: sqlserver_process_check
      changed_when: false
      failed_when: false

    - name: "VÃ©rification rÃ©pertoire SQL Server"
      ansible.builtin.stat:
        path: /opt/mssql
      register: sqlserver_dir_check

    - name: "Ajout de SQL Server Ã  la liste des MIDDLEWARES dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'SQL_Server', 'type': 'database', 'path': '/opt/mssql', 'version': 'N/A', 'status': 'installed', 'processes': sqlserver_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['sqlserver'] }}"
        users_to_create: "{{ users_to_create + ['sqladmin'] }}"
      when:
        - sqlserver_process_check.stdout | int > 0
        - sqlserver_dir_check.stat.exists

# ===== DÃ‰TECTION MQ =====
- name: "DÃ©tection IBM MQ"
  block:
    - name: "VÃ©rification des rÃ©pertoires MQ"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/mqm
        - /usr/mqm
      register: mq_dir_check

    - name: "VÃ©rification du processus MQ"
      ansible.builtin.shell: |
        pgrep -f "amqzxma0|runmqchi" | wc -l
      register: mq_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de MQ Ã  la liste des MIDDLEWARES dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'IBM_MQ', 'type': 'messaging', 'path': '/opt/mqm', 'version': 'N/A', 'status': 'installed', 'processes': mq_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['mq'] }}"
        users_to_create: "{{ users_to_create + ['mqm'] }}"
      when:
        - mq_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (mq_process_check.stdout | int) > 0

# ===== DÃ‰TECTION CFT =====
- name: "DÃ©tection Axway CFT"
  block:
    - name: "VÃ©rification des rÃ©pertoires CFT"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/axway
        - /opt/cft
      register: cft_dir_check

    - name: "VÃ©rification du processus CFT"
      ansible.builtin.shell: |
        pgrep -f "cftmain|cfttcp" | wc -l
      register: cft_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de CFT Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'Axway_CFT', 'type': 'file_transfer', 'path': '/opt/axway', 'version': 'N/A', 'status': 'installed', 'processes': cft_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['cft'] }}"
        users_to_create: "{{ users_to_create + ['cft'] }}"
      when:
        - cft_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (cft_process_check.stdout | int) > 0

# ===== DÃ‰TECTION IHS =====
- name: "DÃ©tection IBM HTTP Server (IHS)"
  block:
    - name: "VÃ©rification des rÃ©pertoires IHS"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/HTTPServer
        - /usr/IBM/HTTPServer
      register: ihs_dir_check

    - name: "VÃ©rification processus IHS"
      ansible.builtin.shell: |
        pgrep -f "IBM/HTTPServer" | wc -l
      register: ihs_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de IHS Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'IBM_HTTP_Server', 'type': 'web_server', 'path': '/opt/IBM/HTTPServer', 'version': 'N/A', 'status': 'installed', 'processes': ihs_process_check.stdout | int}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['ihs'] }}"
      when:
        - ihs_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (ihs_process_check.stdout | int) > 0

# ===== DÃ‰TECTION JVM =====
- name: "DÃ©tection JVM (Java Virtual Machine)"
  block:
    - name: "VÃ©rification Java installÃ©"
      ansible.builtin.shell: |
        java -version 2>&1 | head -1 || echo "N/A"
      register: jvm_version
      changed_when: false
      failed_when: false

    - name: "Ajout JVM Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'JVM', 'type': 'runtime', 'path': 'N/A', 'version': jvm_version.stdout | default('N/A'), 'status': 'installed'}] }}"
        middleware_to_configure: "{{ middleware_to_configure + ['jvm'] }}"
      when:
        - jvm_version.rc == 0
        - "'version' in jvm_version.stdout or 'openjdk' in jvm_version.stdout"

# ===== DÃ‰TECTION SERVICES SYSTÃˆME (PAR CATÃ‰GORIES services.txt) =====

- name: "RÃ©cupÃ©ration de la liste COMPLÃˆTE des services actifs"
  ansible.builtin.shell: |
    systemctl list-units --type=service --state=active --no-pager --no-legend | awk '{print $1}' | sed 's/.service$//' | sort -u
  register: active_services_raw
  changed_when: false
  failed_when: false

- name: "Affichage debug services bruts"
  ansible.builtin.debug:
    msg: "Services actifs bruts dÃ©tectÃ©s : {{ active_services_raw.stdout_lines | length }}"

# CatÃ©gorie 1 : Synchronisation et Temps
- name: "DÃ©tection services - Synchronisation et Temps"
  ansible.builtin.set_fact:
    services_time_sync: >-
      {{
        [
          {'name': 'chronyd', 'category': 'Synchronisation et Temps', 'description': 'NTP Time Synchronization'},
          {'name': 'ntpd', 'category': 'Synchronisation et Temps', 'description': 'NTP Daemon'},
          {'name': 'systemd-timesyncd', 'category': 'Synchronisation et Temps', 'description': 'systemd Time Sync'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 2 : Connexion et SÃ©curitÃ©
- name: "DÃ©tection services - Connexion et SÃ©curitÃ©"
  ansible.builtin.set_fact:
    services_security: >-
      {{
        [
          {'name': 'sshd', 'category': 'Connexion et SÃ©curitÃ©', 'description': 'SSH Daemon'},
          {'name': 'sssd', 'category': 'Connexion et SÃ©curitÃ©', 'description': 'System Security Services'},
          {'name': 'firewalld', 'category': 'Connexion et SÃ©curitÃ©', 'description': 'Firewall Service'},
          {'name': 'iptables', 'category': 'Connexion et SÃ©curitÃ©', 'description': 'IPTables Firewall'},
          {'name': 'auditd', 'category': 'Connexion et SÃ©curitÃ©', 'description': 'Audit Daemon'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 3 : Journalisation
- name: "DÃ©tection services - Journalisation"
  ansible.builtin.set_fact:
    services_logging: >-
      {{
        [
          {'name': 'rsyslog', 'category': 'Journalisation', 'description': 'System Logging'},
          {'name': 'filebeat', 'category': 'Journalisation', 'description': 'Elastic Filebeat'},
          {'name': 'syslog-ng', 'category': 'Journalisation', 'description': 'Syslog-NG Logging'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 4 : Planification de TÃ¢ches
- name: "DÃ©tection services - Planification de TÃ¢ches"
  ansible.builtin.set_fact:
    services_scheduling: >-
      {{
        [
          {'name': 'crond', 'category': 'Planification de TÃ¢ches', 'description': 'Cron Daemon'},
          {'name': 'atd', 'category': 'Planification de TÃ¢ches', 'description': 'AT Daemon'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 5 : Agents et Supervision
- name: "DÃ©tection services - Agents et Supervision"
  ansible.builtin.set_fact:
    services_monitoring: >-
      {{
        [
          {'name': 'elastic-agent', 'category': 'Agents et Supervision', 'description': 'Elastic Agent'},
          {'name': 'dynatrace', 'category': 'Agents et Supervision', 'description': 'Dynatrace OneAgent'},
          {'name': 'oneagent', 'category': 'Agents et Supervision', 'description': 'Dynatrace OneAgent'},
          {'name': 'lvm2-monitor', 'category': 'Agents et Supervision', 'description': 'LVM2 Monitoring'},
          {'name': 'nimbus', 'category': 'Agents et Supervision', 'description': 'Nimsoft Monitoring'},
          {'name': 'metricbeat', 'category': 'Agents et Supervision', 'description': 'Elastic Metricbeat'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 6 : Sauvegarde et Gestion des DonnÃ©es
- name: "DÃ©tection services - Sauvegarde et Gestion des DonnÃ©es"
  ansible.builtin.set_fact:
    services_backup: >-
      {{
        [
          {'name': 'dsmcad', 'category': 'Sauvegarde et Gestion des DonnÃ©es', 'description': 'TSM Client Daemon'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 7 : SÃ©curitÃ© et Protection
- name: "DÃ©tection services - SÃ©curitÃ© et Protection"
  ansible.builtin.set_fact:
    services_protection: >-
      {{
        [
          {'name': 'mcafee', 'category': 'SÃ©curitÃ© et Protection', 'description': 'McAfee Antivirus'},
          {'name': 'eTAC', 'category': 'SÃ©curitÃ© et Protection', 'description': 'eTAC Service'},
          {'name': 'illumio-ven', 'category': 'SÃ©curitÃ© et Protection', 'description': 'Illumio VEN'},
          {'name': 'clamav', 'category': 'SÃ©curitÃ© et Protection', 'description': 'ClamAV Antivirus'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 8 : RÃ©seau
- name: "DÃ©tection services - RÃ©seau"
  ansible.builtin.set_fact:
    services_network: >-
      {{
        [
          {'name': 'snmpd', 'category': 'RÃ©seau', 'description': 'SNMP Daemon'},
          {'name': 'NetworkManager', 'category': 'RÃ©seau', 'description': 'Network Manager'},
          {'name': 'multipathd', 'category': 'RÃ©seau', 'description': 'Multipath Daemon'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# CatÃ©gorie 9 : SystÃ¨me
- name: "DÃ©tection services - SystÃ¨me"
  ansible.builtin.set_fact:
    services_system: >-
      {{
        [
          {'name': 'tuned', 'category': 'SystÃ¨me', 'description': 'Tuning Daemon'},
          {'name': 'postfix', 'category': 'SystÃ¨me', 'description': 'Mail Transfer Agent'},
          {'name': 'sendmail', 'category': 'SystÃ¨me', 'description': 'Sendmail MTA'}
        ] | selectattr('name', 'in', active_services_raw.stdout) | list
      }}

# Consolidation de tous les services
- name: "Consolidation de tous les services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_services: >-
      {{
        (services_time_sync | default([]))
        + (services_security | default([]))
        + (services_logging | default([]))
        + (services_scheduling | default([]))
        + (services_monitoring | default([]))
        + (services_backup | default([]))
        + (services_protection | default([]))
        + (services_network | default([]))
        + (services_system | default([]))
      }}

# ===== CONSOLIDATION FINALE =====
- name: "Consolidation finale des middlewares et services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_summary:
      middlewares: "{{ detected_middlewares }}"
      services: "{{ detected_services }}"
      total_components: "{{ (detected_middlewares | length) + (detected_services | length) }}"
      middleware_to_configure: "{{ middleware_to_configure | unique }}"
      users_to_create: "{{ users_to_create | unique }}"

- name: "Affichage du rÃ©sumÃ© de dÃ©tection COMPLET PAR CATÃ‰GORIES"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘  DÃ‰TECTION MIDDLEWARES ET SERVICES - VERSION CATÃ‰GORISÃ‰E          â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ–¥ï¸  Serveur: {{ ansible_hostname }}"
      - "ğŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - ""
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ğŸ“¦ MIDDLEWARES DÃ‰TECTÃ‰S ({{ detected_middlewares | length }})"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

- name: "Affichage dÃ©tail middlewares"
  ansible.builtin.debug:
    msg:
      - "  {{ item_index + 1 }}. {{ item.name }} ({{ item.type }})"
      - "     ğŸ“‚ Chemin: {{ item.path }}"
      - "     ğŸ“¦ Version: {{ item.version | regex_replace('\\n.*', '') | trim }}"
      - "     ğŸ”„ Processus actifs: {{ item.processes | default(0) }}"
  loop: "{{ detected_middlewares }}"
  loop_control:
    index_var: item_index
  when: detected_middlewares | length > 0

- name: "Message si aucun middleware"
  ansible.builtin.debug:
    msg: "  - Aucun middleware dÃ©tectÃ©"
  when: detected_middlewares | length == 0

- name: "Affichage en-tÃªte services"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ğŸ”§ SERVICES SYSTÃˆME DÃ‰TECTÃ‰S ({{ detected_services | length }})"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""

- name: "Affichage services par catÃ©gorie - Synchronisation et Temps"
  ansible.builtin.debug:
    msg:
      - "â–¶ Synchronisation et Temps ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'Synchronisation et Temps') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - Connexion et SÃ©curitÃ©"
  ansible.builtin.debug:
    msg:
      - "â–¶ Connexion et SÃ©curitÃ© ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'Connexion et SÃ©curitÃ©') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - Journalisation"
  ansible.builtin.debug:
    msg:
      - "â–¶ Journalisation ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'Journalisation') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - Planification de TÃ¢ches"
  ansible.builtin.debug:
    msg:
      - "â–¶ Planification de TÃ¢ches ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'Planification de TÃ¢ches') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - Agents et Supervision"
  ansible.builtin.debug:
    msg:
      - "â–¶ Agents et Supervision ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'Agents et Supervision') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - Sauvegarde et Gestion des DonnÃ©es"
  ansible.builtin.debug:
    msg:
      - "â–¶ Sauvegarde et Gestion des DonnÃ©es ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'Sauvegarde et Gestion des DonnÃ©es') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - SÃ©curitÃ© et Protection"
  ansible.builtin.debug:
    msg:
      - "â–¶ SÃ©curitÃ© et Protection ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'SÃ©curitÃ© et Protection') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - RÃ©seau"
  ansible.builtin.debug:
    msg:
      - "â–¶ RÃ©seau ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'RÃ©seau') | list }}"
  when: cat_services | length > 0

- name: "Affichage services par catÃ©gorie - SystÃ¨me"
  ansible.builtin.debug:
    msg:
      - "â–¶ SystÃ¨me ({{ cat_services | length }}):"
      - "{% for svc in cat_services %}  - {{ svc.name }}: {{ svc.description }}{% endfor %}"
  vars:
    cat_services: "{{ detected_services | selectattr('category', 'equalto', 'SystÃ¨me') | list }}"
  when: cat_services | length > 0

- name: "Affichage rÃ©sumÃ© final"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ğŸ“Š RÃ‰SUMÃ‰"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "Total Middlewares: {{ detected_middlewares | length }}"
      - "Total Services: {{ detected_services | length }}"
      - "Total Composants: {{ detected_summary.total_components }}"
      - ""
      - "ğŸ”¨ Middlewares Ã  installer/configurer: {{ middleware_to_configure | length }}"
      - "   {{ middleware_to_configure | join(', ') if middleware_to_configure | length > 0 else 'Aucun' }}"
      - ""
      - "ğŸ‘¥ Utilisateurs techniques Ã  crÃ©er: {{ users_to_create | length }}"
      - "   {{ users_to_create | join(', ') if users_to_create | length > 0 else 'Aucun' }}"
      - ""
      - "âœ… DÃ©tection terminÃ©e avec succÃ¨s"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""

- name: "Enregistrement des facts pour les autres rÃ´les"
  ansible.builtin.set_fact:
    detected_middleware_list: "{{ detected_middlewares }}"
    detected_service_list: "{{ detected_services }}"
    middleware_to_configure_list: "{{ middleware_to_configure }}"
    users_to_create_list: "{{ users_to_create }}"
    users_middlewares: "{{ users_to_create }}"
    app_environment_detected: true
    cacheable: true

---

- name: "Initialisation de la liste des middlewares et services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_middlewares: []
    detected_services: []
    detected_packages: []

# ===== DÃ‰TECTION WEBSERVER / WAS =====
- name: "DÃ©tection WebSphere Application Server (WAS)"
  block:
    - name: "VÃ©rification des rÃ©pertoires WAS WASND"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/WebSphere/AppServer
        - /usr/IBM/WebSphere/AppServer
      register: was_dir_check

    - name: "Extraction de la version WAS si prÃ©sent"
      ansible.builtin.shell: |
        grep -r "PRODUCT_VERSION" /opt/IBM/WebSphere/AppServer/properties/version.txt 2>/dev/null | head -1 || echo "WAS WASND DETECTED"
      register: was_version
      changed_when: false
      failed_when: false
      when: was_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de WAS Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + ['WebSphere_WASND'] }}"
      when: 
        - was_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - was_version.rc == 0

# ===== DÃ‰TECTION LIBERTY =====
- name: "DÃ©tection WebSphere Liberty"
  block:
    - name: "VÃ©rification des rÃ©pertoires Liberty"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/WebSphere/Liberty
        - /usr/IBM/WebSphere/Liberty
        - /opt/wlp
      register: liberty_dir_check

    - name: "Extraction de la version Liberty si prÃ©sent"
      ansible.builtin.shell: |
        find /opt/IBM/WebSphere/Liberty /opt/wlp -name "wlp-*" -o -name "Liberty*" 2>/dev/null | head -1 || echo "Liberty DETECTED"
      register: liberty_version
      changed_when: false
      failed_when: false
      when: liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de Liberty Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + ['Liberty_Core'] }}"
      when: 
        - liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - liberty_version.rc == 0

# ===== DÃ‰TECTION ORACLE - STRICTE =====
- name: "DÃ©tection Oracle Database (STRICTE - vÃ©rification du fichier oratab)"
  block:
    - name: "VÃ©rification du fichier oratab (fichier spÃ©cifique Oracle)"
      ansible.builtin.stat:
        path: /etc/oratab
      register: oratab_check

    - name: "VÃ©rification du processus Oracle smon (PMON)"
      ansible.builtin.shell: |
        pgrep -f "ora_.*_pmon" | wc -l
      register: oracle_process_check
      changed_when: false
      failed_when: false

    - name: "VÃ©rification du rÃ©pertoire Oracle ORACLE_HOME"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /u01/app/oracle/product
        - /opt/oracle/product
        - /home/oracle/app/oracle/product
      register: oracle_dir_check

    - name: "Ajout d'Oracle Ã  la liste des MIDDLEWARES (si oratab ET processus prÃ©sents)"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + ['Oracle_Database'] }}"
      when:
        - oratab_check.stat.exists
        - (oracle_process_check.stdout | int) > 0
        - oracle_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

# ===== DÃ‰TECTION MQ =====
- name: "DÃ©tection IBM MQ"
  block:
    - name: "VÃ©rification des rÃ©pertoires MQ"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/mqm
        - /usr/mqm
        - /var/mqm
      register: mq_dir_check

    - name: "VÃ©rification du processus MQ"
      ansible.builtin.shell: |
        pgrep -f "amqzxma0|runmqchi" | wc -l
      register: mq_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de MQ Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + ['IBM_MQ'] }}"
      when:
        - mq_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (mq_process_check.stdout | int) > 0

# ===== DÃ‰TECTION CFT =====
- name: "DÃ©tection Axway CFT"
  block:
    - name: "VÃ©rification des rÃ©pertoires CFT"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/axway
        - /opt/cft
        - /opt/transfer
      register: cft_dir_check

    - name: "VÃ©rification du processus CFT"
      ansible.builtin.shell: |
        pgrep -f "cftmain|cfttcp" | wc -l
      register: cft_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de CFT Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + ['Axway_CFT'] }}"
      when:
        - cft_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (cft_process_check.stdout | int) > 0

# ===== DÃ‰TECTION SERVICES SYSTÃˆME =====
- name: "DÃ©tection des services systÃ¨me activÃ©s"
  block:
    - name: "RÃ©cupÃ©ration de la liste des services actifs"
      ansible.builtin.shell: |
        systemctl list-units --type=service --state=active --no-pager | grep -E "loaded|active" | awk '{print $1}' | sed 's/.service$//' | sort -u
      register: active_services
      changed_when: false
      failed_when: false

    - name: "Recherche des services critiques"
      ansible.builtin.set_fact:
        detected_services: |
          [
          {%- set critical_services = ['chronyd', 'ntpd', 'filebeat', 'elastic-agent', 'eTAC', 'illumio-ven', 'dynatrace', 'dsmcad'] -%}
          {%- for service in critical_services -%}
            {%- if service in active_services.stdout -%}
              '{{ service }}'{{ "," if not loop.last else "" }}
            {%- endif -%}
          {%- endfor -%}
          ]

# ===== CONSOLIDATION FINALE =====
- name: "Consolidation finale des middlewares et services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_summary:
      middlewares: "{{ detected_middlewares }}"
      services: "{{ detected_services | default([]) }}"
      total_components: "{{ (detected_middlewares | length) + (detected_services | length) }}"

- name: "Affichage du rÃ©sumÃ© de dÃ©tection CORRIGÃ‰"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘  DÃ‰TECTION MIDDLEWARES ET SERVICES - VERSION CORRIGÃ‰E              â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ–¥ï¸  Serveur: {{ ansible_hostname }}"
      - "ğŸ§ OS: Linux {{ ansible_distribution }}"
      - ""
      - "ğŸ“¦ MIDDLEWARES DÃ‰TECTÃ‰S ({{ detected_middlewares | length }}):"
      - "{{ detected_middlewares | map(attribute='name', default='  - ' + item) | list | join('\n') if detected_middlewares | length > 0 else '  - Aucun middleware dÃ©tectÃ©' }}"
      - ""
      - "ğŸ”§ SERVICES CRITIQUES DÃ‰TECTÃ‰S ({{ detected_services | length }}):"
      - "{{ detected_services | map(attribute='name', default='  - ' + item) | list | join('\n') if detected_services | length > 0 else '  - Aucun service dÃ©tectÃ©' }}"
      - ""
      - "ğŸ“Š TOTAL COMPOSANTS: {{ detected_summary.total_components }}"
      - ""

- name: "Enregistrement des facts pour les autres rÃ´les"
  ansible.builtin.set_fact:
    detected_middleware_list: "{{ detected_middlewares }}"
    detected_service_list: "{{ detected_services }}"
    app_environment_detected: true

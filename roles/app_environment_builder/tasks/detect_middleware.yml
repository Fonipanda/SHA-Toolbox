---

- name: "Initialisation de la liste des middlewares et services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_middlewares: []
    detected_services: []
    detected_packages: []

# ===== DÃ‰TECTION WEBSERVER / WAS =====
- name: "DÃ©tection WebSphere Application Server (WAS)"
  block:
    - name: "VÃ©rification des rÃ©pertoires WAS WASND"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/WebSphere/AppServer
        - /usr/IBM/WebSphere/AppServer
      register: was_dir_check

    - name: "Extraction de la version WAS si prÃ©sent"
      ansible.builtin.shell: |
        grep -r "PRODUCT_VERSION" /opt/IBM/WebSphere/AppServer/properties/version.txt 2>/dev/null | head -1 || echo "WAS WASND DETECTED"
      register: was_version
      changed_when: false
      failed_when: false
      when: was_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de WAS Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'WebSphere_WASND', 'path': '/opt/IBM/WebSphere/AppServer', 'version': was_version.stdout | default('N/A')}] }}"
      when: 
        - was_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - was_version.rc == 0

# ===== DÃ‰TECTION LIBERTY =====
- name: "DÃ©tection WebSphere Liberty"
  block:
    - name: "VÃ©rification des rÃ©pertoires Liberty"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/IBM/WebSphere/Liberty
        - /usr/IBM/WebSphere/Liberty
        - /opt/wlp
      register: liberty_dir_check

    - name: "Extraction de la version Liberty si prÃ©sent"
      ansible.builtin.shell: |
        find /opt/IBM/WebSphere/Liberty /opt/wlp -name "wlp-*" -o -name "Liberty*" 2>/dev/null | head -1 || echo "Liberty DETECTED"
      register: liberty_version
      changed_when: false
      failed_when: false
      when: liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de Liberty Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'Liberty_Core', 'path': '/opt/IBM/WebSphere/Liberty', 'version': liberty_version.stdout | default('N/A')}] }}"
      when: 
        - liberty_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - liberty_version.rc == 0

# ===== DÃ‰TECTION ORACLE - STRICTE =====
- name: "DÃ©tection Oracle Database (STRICTE - vÃ©rification du fichier oratab)"
  block:
    - name: "VÃ©rification du fichier oratab (fichier spÃ©cifique Oracle)"
      ansible.builtin.stat:
        path: /etc/oratab
      register: oratab_check

    - name: "VÃ©rification du processus Oracle smon (PMON)"
      ansible.builtin.shell: |
        pgrep -f "ora_.*_pmon" | wc -l
      register: oracle_process_check
      changed_when: false
      failed_when: false

    - name: "VÃ©rification du rÃ©pertoire Oracle ORACLE_HOME"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /u01/app/oracle/product
        - /opt/oracle/product
        - /home/oracle/app/oracle/product
      register: oracle_dir_check

    - name: "RÃ©cupÃ©ration version Oracle si prÃ©sente"
      ansible.builtin.shell: |
        cat /etc/oratab | grep -v "^#" | grep -v "^$" | head -1 | cut -d: -f1 || echo "Oracle"
      register: oracle_version
      changed_when: false
      failed_when: false
      when: oratab_check.stat.exists

    - name: "Ajout d'Oracle Ã  la liste des MIDDLEWARES (si oratab ET processus prÃ©sents)"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'Oracle_Database', 'path': '/u01/app/oracle', 'version': oracle_version.stdout | default('N/A')}] }}"
      when:
        - oratab_check.stat.exists
        - (oracle_process_check.stdout | int) > 0
        - oracle_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

# ===== DÃ‰TECTION MQ =====
- name: "DÃ©tection IBM MQ"
  block:
    - name: "VÃ©rification des rÃ©pertoires MQ"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/mqm
        - /usr/mqm
        - /var/mqm
      register: mq_dir_check

    - name: "VÃ©rification du processus MQ"
      ansible.builtin.shell: |
        pgrep -f "amqzxma0|runmqchi" | wc -l
      register: mq_process_check
      changed_when: false
      failed_when: false

    - name: "RÃ©cupÃ©ration version MQ"
      ansible.builtin.shell: |
        /opt/mqm/bin/dspmqver 2>/dev/null | grep Version | head -1 || echo "MQ Detected"
      register: mq_version
      changed_when: false
      failed_when: false
      when: mq_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: "Ajout de MQ Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'IBM_MQ', 'path': '/opt/mqm', 'version': mq_version.stdout | default('N/A')}] }}"
      when:
        - mq_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (mq_process_check.stdout | int) > 0

# ===== DÃ‰TECTION CFT =====
- name: "DÃ©tection Axway CFT"
  block:
    - name: "VÃ©rification des rÃ©pertoires CFT"
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /opt/axway
        - /opt/cft
        - /opt/transfer
      register: cft_dir_check

    - name: "VÃ©rification du processus CFT"
      ansible.builtin.shell: |
        pgrep -f "cftmain|cfttcp" | wc -l
      register: cft_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de CFT Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'Axway_CFT', 'path': '/opt/axway', 'version': 'N/A'}] }}"
      when:
        - cft_dir_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
        - (cft_process_check.stdout | int) > 0

# ===== DÃ‰TECTION SQL SERVER (Windows) =====
- name: "DÃ©tection SQL Server (si Windows)"
  block:
    - name: "VÃ©rification service SQL Server"
      ansible.builtin.shell: |
        pgrep -f "sqlservr" | wc -l
      register: sqlserver_process_check
      changed_when: false
      failed_when: false

    - name: "Ajout de SQL Server Ã  la liste des MIDDLEWARES"
      ansible.builtin.set_fact:
        detected_middlewares: "{{ detected_middlewares + [{'name': 'SQL_Server', 'path': '/opt/mssql', 'version': 'N/A'}] }}"
      when:
        - (sqlserver_process_check.stdout | int) > 0
  when: ansible_os_family == "Windows" or ansible_distribution == "Microsoft"

# ===== DÃ‰TECTION SERVICES SYSTÃˆME (AMÃ‰LIORÃ‰E) =====
- name: "DÃ©tection des services systÃ¨me activÃ©s (COMPLÃˆTE)"
  block:
    - name: "RÃ©cupÃ©ration de la liste COMPLÃˆTE des services actifs"
      ansible.builtin.shell: |
        systemctl list-units --type=service --state=active --no-pager --no-legend | awk '{print $1}' | sed 's/.service$//' | sort -u
      register: active_services_raw
      changed_when: false
      failed_when: false

    - name: "Affichage debug services bruts"
      ansible.builtin.debug:
        msg: "Services actifs bruts dÃ©tectÃ©s : {{ active_services_raw.stdout_lines | length }}"

    - name: "Construction de la liste des services critiques dÃ©tectÃ©s"
      ansible.builtin.set_fact:
        detected_services: >-
          {{
            [
              {'name': 'chronyd', 'description': 'NTP Time Synchronization'},
              {'name': 'ntpd', 'description': 'NTP Daemon'},
              {'name': 'systemd-timesyncd', 'description': 'systemd Time Sync'},
              {'name': 'sshd', 'description': 'SSH Daemon'},
              {'name': 'firewalld', 'description': 'Firewall Service'},
              {'name': 'iptables', 'description': 'IPTables Firewall'},
              {'name': 'rsyslog', 'description': 'System Logging'},
              {'name': 'auditd', 'description': 'Audit Daemon'},
              {'name': 'crond', 'description': 'Cron Daemon'},
              {'name': 'atd', 'description': 'AT Daemon'},
              {'name': 'filebeat', 'description': 'Elastic Filebeat'},
              {'name': 'elastic-agent', 'description': 'Elastic Agent'},
              {'name': 'metricbeat', 'description': 'Elastic Metricbeat'},
              {'name': 'eTAC', 'description': 'eTAC Service'},
              {'name': 'illumio-ven', 'description': 'Illumio VEN'},
              {'name': 'dynatrace', 'description': 'Dynatrace OneAgent'},
              {'name': 'oneagent', 'description': 'Dynatrace OneAgent'},
              {'name': 'dsmcad', 'description': 'TSM Client Daemon'},
              {'name': 'nimbus', 'description': 'Nimsoft Monitoring'},
              {'name': 'mcafee', 'description': 'McAfee Antivirus'},
              {'name': 'clamav', 'description': 'ClamAV Antivirus'},
              {'name': 'snmpd', 'description': 'SNMP Daemon'},
              {'name': 'postfix', 'description': 'Mail Transfer Agent'},
              {'name': 'sendmail', 'description': 'Sendmail MTA'},
              {'name': 'httpd', 'description': 'Apache Web Server'},
              {'name': 'nginx', 'description': 'Nginx Web Server'},
              {'name': 'docker', 'description': 'Docker Engine'},
              {'name': 'containerd', 'description': 'Container Runtime'},
              {'name': 'NetworkManager', 'description': 'Network Manager'},
              {'name': 'tuned', 'description': 'Tuning Daemon'},
              {'name': 'multipathd', 'description': 'Multipath Daemon'},
              {'name': 'lvm2-monitor', 'description': 'LVM2 Monitoring'},
              {'name': 'sssd', 'description': 'System Security Services'}
            ] | selectattr('name', 'in', active_services_raw.stdout) | list
          }}

    - name: "Ajout des services spÃ©cifiques IBM/Oracle"
      ansible.builtin.set_fact:
        detected_services: >-
          {{
            detected_services + 
            (
              [
                {'name': 'was', 'description': 'WebSphere App Server'},
                {'name': 'liberty', 'description': 'Liberty Server'},
                {'name': 'oracleasm', 'description': 'Oracle ASM'},
                {'name': 'oracle', 'description': 'Oracle Database'},
                {'name': 'mqm', 'description': 'IBM MQ Manager'}
              ] | selectattr('name', 'in', active_services_raw.stdout) | list
            )
          }}

# ===== CONSOLIDATION FINALE =====
- name: "Consolidation finale des middlewares et services dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_summary:
      middlewares: "{{ detected_middlewares }}"
      services: "{{ detected_services }}"
      total_components: "{{ (detected_middlewares | length) + (detected_services | length) }}"

- name: "Affichage du rÃ©sumÃ© de dÃ©tection CORRIGÃ‰"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘  DÃ‰TECTION MIDDLEWARES ET SERVICES - VERSION COMPLÃˆTE             â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ–¥ï¸  Serveur: {{ ansible_hostname }}"
      - "ğŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - ""
      - "ğŸ“¦ MIDDLEWARES DÃ‰TECTÃ‰S ({{ detected_middlewares | length }}):"
      - "{% if detected_middlewares | length > 0 %}{% for mw in detected_middlewares %}  - {{ mw.name }} ({{ mw.path }}){% endfor %}{% else %}  - Aucun middleware dÃ©tectÃ©{% endif %}"
      - ""
      - "ğŸ”§ SERVICES SYSTÃˆME DÃ‰TECTÃ‰S ({{ detected_services | length }}):"
      - "{% if detected_services | length > 0 %}{% for svc in detected_services %}  - {{ svc.name }} : {{ svc.description }}{% endfor %}{% else %}  - Aucun service critique dÃ©tectÃ©{% endif %}"
      - ""
      - "ğŸ“Š TOTAL COMPOSANTS: {{ detected_summary.total_components }}"
      - ""
      - "âœ… DÃ©tection terminÃ©e avec succÃ¨s"
      - ""

- name: "Enregistrement des facts pour les autres rÃ´les"
  ansible.builtin.set_fact:
    detected_middleware_list: "{{ detected_middlewares }}"
    detected_service_list: "{{ detected_services }}"
    app_environment_detected: true
    cacheable: true

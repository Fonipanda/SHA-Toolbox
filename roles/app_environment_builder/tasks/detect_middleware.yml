---
- name: "Init lists"
  ansible.builtin.set_fact:
    detected_middleware_list: []
    detected_services_list: []

- name: "Detect WebSphere"
  ansible.builtin.shell: |
    if [ -d /opt/IBM/WebSphere ]; then echo "WebSphere_WAS_ND"; fi
  register: ws_detect
  changed_when: false
- name: "Add WebSphere"
  ansible.builtin.set_fact:
    detected_middleware_list: "{{ detected_middleware_list + [ws_detect.stdout] }}"
  when: ws_detect.stdout != ""

- name: "Detect Illumio service"
  ansible.builtin.shell: |
    systemctl list-units --all | grep -q illumio-ven && echo "Illumio"
  register: ill_detect
  changed_when: false
- name: "Add Illumio"
  ansible.builtin.set_fact:
    detected_services_list: "{{ detected_services_list + [ill_detect.stdout] }}"
  when: ill_detect.stdout != ""

- name: "Detect TSM"
  ansible.builtin.shell: |
    systemctl list-units --all | grep -q dsmsvc && echo "TSM"
  register: tsm_detect
  changed_when: false
- name: "Add TSM"
  ansible.builtin.set_fact:
    detected_services_list: "{{ detected_services_list + [tsm_detect.stdout] }}"
  when: tsm_detect.stdout != ""

- name: "Detect Dynatrace"
  ansible.builtin.shell: |
    ps -ef | grep -q oneagent && echo "Dynatrace"
  register: dt_detect
  changed_when: false
- name: "Add Dynatrace"
  ansible.builtin.set_fact:
    detected_services_list: "{{ detected_services_list + [dt_detect.stdout] }}"
  when: dt_detect.stdout != ""

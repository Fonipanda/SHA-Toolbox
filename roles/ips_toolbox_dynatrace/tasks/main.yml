---

- name: "VÃ©rification de l'installation de Dynatrace OneAgent"
  ansible.builtin.stat:
    path: /apps/dynatrace/oneagent/agent/tools/oneagentctl
  register: dynatrace_installed

- name: "ArrÃªt si Dynatrace non installÃ©"
  ansible.builtin.debug:
    msg: "âš ï¸ Dynatrace OneAgent non installÃ© sur ce serveur"
  when: not dynatrace_installed.stat.exists

- name: "Bloc de vÃ©rification Dynatrace"
  block:
    - name: "VÃ©rification de la version de Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl --version
      register: dynatrace_version
      changed_when: false
      failed_when: false

    - name: "VÃ©rification du statut de l'agent Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl status
      register: dynatrace_status
      changed_when: false
      failed_when: false

    - name: "Affichage de la version et du statut"
      ansible.builtin.debug:
        msg:
          - "ğŸ“Š Version Dynatrace : {{ dynatrace_version.stdout_lines[0] if dynatrace_version.stdout_lines is defined else 'N/A' }}"
          - "ğŸ“Š Statut : {{ dynatrace_status.stdout_lines | default(['Statut inconnu']) | join(' ') }}"

    - name: "DÃ©tection si l'agent est arrÃªtÃ©"
      ansible.builtin.set_fact:
        dynatrace_is_stopped: "{{ 'not running' in dynatrace_status.stdout or 'stopped' in dynatrace_status.stdout }}"

    - name: "DÃ©marrage de l'agent Dynatrace si arrÃªtÃ©"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl restart
      register: dynatrace_start_result
      when: dynatrace_is_stopped | bool
      changed_when: true
      failed_when: false

    - name: "Affichage du rÃ©sultat de dÃ©marrage"
      ansible.builtin.debug:
        msg:
          - "âœ… Agent Dynatrace dÃ©marrÃ© avec succÃ¨s"
          - "{{ dynatrace_start_result.stdout_lines | default(['Aucune sortie']) }}"
      when: 
        - dynatrace_is_stopped | bool
        - dynatrace_start_result is defined

    - name: "VÃ©rification du mode Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl --get-mode
      register: dynatrace_mode
      changed_when: false
      failed_when: false

    - name: "Affichage du mode actuel"
      ansible.builtin.debug:
        msg: "ğŸ”§ Mode Dynatrace : {{ dynatrace_mode.stdout | default('Mode inconnu') }}"

    - name: "Enregistrement du rÃ©sultat"
      ansible.builtin.include_role:
        name: ips_toolbox_set_results
      vars:
        set_results_state: "checked"
        set_results_item: "dynatrace"
        set_results_value: "Agent Dynatrace actif - Mode {{ dynatrace_mode.stdout | default('unknown') }}"
        set_results_component: "dynatrace"
        set_results_operation: "check"
        set_results_status: "{{ 'OK' if not (dynatrace_is_stopped | bool) else 'RESTARTED' }}"
      ignore_errors: yes

  when: dynatrace_installed.stat.exists
  rescue:
    - name: "Gestion des erreurs Dynatrace"
      ansible.builtin.debug:
        msg:
          - "âŒ Erreur lors de la vÃ©rification de Dynatrace"
          - "VÃ©rifiez les logs dans /var/log/dynatrace/"

---

- name: "VÃ©rification de l'installation de Dynatrace OneAgent"
  ansible.builtin.stat:
    path: /apps/dynatrace/oneagent/agent/tools/oneagentctl
  register: dynatrace_installed

- name: "Information si Dynatrace non installÃ©"
  ansible.builtin.debug:
    msg: "â„¹ï¸ Dynatrace OneAgent non dÃ©tectÃ© sur ce serveur - IgnorÃ©"
  when: not dynatrace_installed.stat.exists

- name: "Bloc de vÃ©rification Dynatrace"
  block:
    - name: "VÃ©rification de la version de Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl --version
      register: dynatrace_version
      changed_when: false
      failed_when: false

    - name: "VÃ©rification du statut de l'agent Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl status
      register: dynatrace_status
      changed_when: false
      failed_when: false

    - name: "Affichage des informations Dynatrace"
      ansible.builtin.debug:
        msg:
          - "ğŸ“Š Dynatrace OneAgent dÃ©tectÃ©"
          - "Version : {{ dynatrace_version.stdout_lines[0] if dynatrace_version.stdout_lines is defined else 'N/A' }}"
          - "Statut : {{ dynatrace_status.stdout | default('Statut inconnu') }}"

    - name: "DÃ©tection si l'agent est arrÃªtÃ©"
      ansible.builtin.set_fact:
        dynatrace_needs_restart: "{{ 'not running' in dynatrace_status.stdout or 'stopped' in dynatrace_status.stdout }}"

    - name: "RedÃ©marrage de l'agent Dynatrace si nÃ©cessaire"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl restart
      register: dynatrace_restart_result
      when: dynatrace_needs_restart | bool
      changed_when: true
      failed_when: false

    - name: "Affichage du rÃ©sultat de redÃ©marrage"
      ansible.builtin.debug:
        msg:
          - "âœ… Agent Dynatrace redÃ©marrÃ© avec succÃ¨s"
          - "{{ dynatrace_restart_result.stdout | default('Aucune sortie') }}"
      when: 
        - dynatrace_needs_restart | bool
        - dynatrace_restart_result is defined

    - name: "VÃ©rification du mode Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl --get-mode
      register: dynatrace_mode
      changed_when: false
      failed_when: false

    - name: "Affichage du mode final"
      ansible.builtin.debug:
        msg: "ğŸ”§ Mode Dynatrace : {{ dynatrace_mode.stdout | default('Mode inconnu') }}"

  when: dynatrace_installed.stat.exists
  rescue:
    - name: "Gestion des erreurs Dynatrace (non bloquante)"
      ansible.builtin.debug:
        msg:
          - "âš ï¸ Erreur lors de la vÃ©rification de Dynatrace (non critique)"
          - "Le workflow continue normalement"

---

- set_fact:
    controlm_status: "OK"
    controlm_value: ""
    controlm_state: "listed"
- name: List Control-M Agent
  no_log: true
  block:
    - win_shell: Get-CTMAgent | Select-Object Agent -Unique | convertTo-Json
      register: ctmList
      changed_when: False
    - set_fact:
        tmp_json: ""
      when: ctmList.stdout != ""
    - set_fact: ctmListAgents="{{ ctmListAgents|default([]) + [ item.split(':')[1] | replace('\"','') | trim ] }}"
      when: item.find('Agent') > -1
      with_items: "{{ ctmList.stdout_lines }}"
      ignore_errors: yes
    - set_fact:
        controlm_value: "{{ ctmListAgents }}"
      when: ctmListAgents is defined
    - set_fact:
        controlm_value: "no agent name found"
      when: ctmListAgents is not defined
  rescue:
    - set_fact:
        controlm_status: "KO"
        controlm_value: "unknown"
        controlm_state: "not listed"
  always:
    - name: set result output for list Control-M Agent
      ansible.builtin.include_role:
        name: ips_toolbox_set_results
      vars:
        set_results_state: "{{ controlm_state }}"
        set_results_item: ""
        set_results_value: "{{ controlm_value }}"
        set_results_component: "{{ controlm_component }}"
        set_results_operation: "{{ controlm_operation }}"
        set_results_role_name: "{{ controlm_role_name }}"
        set_results_result_name: "{{ controlm_result_name }}"
        set_results_script_mode: "{{ controlm_script_mode }}"
        set_results_status: "{{ controlm_status }}"


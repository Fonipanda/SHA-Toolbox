---

- set_fact:
    controlm_status: "OK"
    controlm_value: ""
    controlm_state: "listed"
- name: List Control-M Agent
  no_log: true
  block:
    - win_shell: "Get-CTMAgent -CTMAgent {{ controlm_agent_name }}"
      register: ctmAgentExist
      changed_when: False
      ignore_errors: yes
    - set_fact:
        controlm_state: "not listed"
        controlm_value: "no agent name found"
      when: ctmAgentExist.stdout == ""
    - script: list_jobs_Win32NT_controlm.ps1 "{{ controlm_agent_name }}"
      register: ctmList
      changed_when: False
      when: ctmAgentExist.stdout != ""
    - set_fact:
        controlm_value: "{{ ctmList.stdout |from_json }}"
      when: 
        - ctmList is defined
        - ctmAgentExist.stdout != ""
    - set_fact:
        controlm_value: "{{ no running jobs }}"
      when: 
        - ctmList is not defined
        - ctmAgentExist.stdout != ""
  rescue:
    - set_fact:
        controlm_status: "KO"
        controlm_value: "unknown"
        controlm_state: "not listed"
  always:
    - name: set result output for list Control-M Agent
      include_role:
        name: ips_toolbox_set_results
      vars:
        set_results_state: "{{ controlm_state }}"
        set_results_item: ""
        set_results_value: "{{ controlm_value }}"
        set_results_component: "{{ controlm_component }}"
        set_results_operation: "{{ controlm_operation }}"
        set_results_role_name: "{{ controlm_role_name }}"
        set_results_result_name: "{{ controlm_result_name }}"
        set_results_script_mode: "{{ controlm_script_mode }}"
        set_results_status: "{{ controlm_status }}"

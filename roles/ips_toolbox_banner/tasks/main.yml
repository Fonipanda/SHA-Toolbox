---

- name: "Initialisation du rôle banner"
  ansible.builtin.set_fact:
    banner_component: "banner"
    banner_operation: "{{ banner_operation | default('create') }}"
    banner_company_name: "{{ banner_company_name | default('Entreprise') }}"

- name: "Récupération du Serial Number via dmidecode"
  ansible.builtin.shell: |
    dmidecode -s system-serial-number 2>/dev/null | head -1 | grep -v '^#' || echo "{{ ansible_product_serial | default('Unknown') }}"
  register: system_serial_number
  changed_when: false
  failed_when: false
  when: ansible_os_family != "Windows"

- name: "Enregistrement du Serial Number"
  ansible.builtin.set_fact:
    banner_serial_number: "{{ system_serial_number.stdout | trim if system_serial_number is defined and system_serial_number.stdout is defined else ansible_product_serial | default('Unknown') }}"

- name: "Création de la bannière PRÉ-LOGIN pour issue (console locale)"
  ansible.builtin.template:
    src: infos_pre_login.j2
    dest: /etc/issue
    mode: '0644'
    owner: root
    group: root
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Création de la bannière PRÉ-LOGIN pour issue.net (SSH)"
  ansible.builtin.template:
    src: infos_pre_login.j2
    dest: /etc/issue.net
    mode: '0644'
    owner: root
    group: root
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Création de la bannière POST-LOGIN (MOTD)"
  ansible.builtin.template:
    src: infos_post_login.j2
    dest: /etc/motd
    mode: '0644'
    owner: root
    group: root
  ignore_errors: true

- name: "Configuration SSH pour afficher la bannière PRÉ-LOGIN"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/issue.net'
    backup: yes
  notify: restart sshd
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Désactivation de PrintLastLog dans SSH (Last login géré par PAM)"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PrintLastLog'
    line: 'PrintLastLog yes'
    backup: yes
  notify: restart sshd
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Affichage du statut de création des bannières"
  ansible.builtin.debug:
    msg:
      - "✅ Bannières créées pour {{ ansible_hostname }}"
      - "   • PRÉ-LOGIN (/etc/issue.net): Disclaimer uniquement"
      - "   • POST-LOGIN (/etc/motd): Informations système complètes"
      - "Type: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "Virtualisation: {{ ansible_virtualization_type | default('physical') }}"
      - "Serial Number: {{ banner_serial_number }}"
      - "Application: {{ banner_codeAP | default('N/A') }}"
      - "Middlewares: {{ banner_middlewares | default('Aucun') }}"

---
- name: "Initialisation du rÃ´le ips_toolbox_logs"
  ansible.builtin.set_fact:
    logs_component: "logs"
    logs_role_name: "ips_toolbox_logs"
    log_purge_retention_days: "{{ log_purge_days | default(30) }}"

- name: "Affichage configuration purge logs"
  ansible.builtin.debug:
    msg:
      - "ğŸ“‹ CONFIGURATION PURGE LOGS"
      - "   â€¢ RÃ©tention: {{ log_purge_retention_days }} jours"
      - "   â€¢ Heure d'exÃ©cution: 01:00"

- name: "VÃ©rification de l'existence du service purge_logs"
  ansible.builtin.shell: |
    systemctl list-units --all | grep -i purge_logs && echo "SERVICE_EXISTS" || echo "SERVICE_MISSING"
  register: purge_logs_service_check
  changed_when: false
  failed_when: false

- name: "VÃ©rification de l'existence du timer purge_logs"
  ansible.builtin.shell: |
    systemctl list-timers --all | grep -i purge_logs && echo "TIMER_EXISTS" || echo "TIMER_MISSING"
  register: purge_logs_timer_check
  changed_when: false
  failed_when: false

- name: "VÃ©rification du fichier exploit_rotate-log.conf"
  ansible.builtin.stat:
    path: /apps/toolboxes/exploit/conf/exploit_rotate-log.conf
  register: rotate_log_conf_check

- name: "CrÃ©ation du service systemd purge_logs.service"
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Purge des logs applicatifs /applis/logs (rÃ©tention {{ log_purge_retention_days }} jours)
      Documentation=file:///apps/toolboxes/exploit/bin/exploit_rotate_log.ksh
      After=multi-user.target

      [Service]
      Type=oneshot
      ExecStart=/apps/toolboxes/exploit/bin/exploit_rotate_log.ksh {{ log_purge_retention_days }}
      User=root
      Group=root
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/purge_logs.service
    mode: '0644'
    owner: root
    group: root
  when: "'SERVICE_MISSING' in purge_logs_service_check.stdout"
  notify: "Recharger systemd"

- name: "CrÃ©ation du timer systemd purge_logs.timer (exÃ©cution Ã  01:00)"
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Timer pour purge automatique des logs (01:00 tous les jours)
      Requires=purge_logs.service

      [Timer]
      OnCalendar=*-*-* 01:00:00
      Persistent=true

      [Install]
      WantedBy=timers.target
    dest: /etc/systemd/system/purge_logs.timer
    mode: '0644'
    owner: root
    group: root
  when: "'TIMER_MISSING' in purge_logs_timer_check.stdout"
  notify: "Recharger systemd"

- name: "CrÃ©ation du fichier de configuration exploit_rotate-log.conf"
  ansible.builtin.copy:
    content: |
      # Configuration rotation et purge des logs - SHA-Toolbox
      # RÃ©tention: {{ log_purge_retention_days }} jours
      # ExÃ©cution: 01:00 tous les jours
      # RÃ©pertoires de logs Ã  traiter
      LOG_DIRS="/applis/logs /apps/exploit/logs /var/log"
      
      # RÃ©tention en jours
      RETENTION_DAYS=30
      
      # RÃ©tention en jours (nombre de jours Ã  conserver)
      RETENTION_DAYS={{ log_purge_retention_days }}
      
      # Compression aprÃ¨s rotation
      COMPRESS=yes
      
      # Extensions de fichiers logs Ã  traiter
      LOG_EXTENSIONS="*.log *.out *.err *.trace"
      
      # Taille maximum avant rotation (en MB)
      MAX_SIZE=100
      
      # Sauvegarde TSM avant purge
      TSM_BACKUP=yes
      
      # Notification par email
      EMAIL_NOTIFICATION=no
      EMAIL_RECIPIENTS=""
      
      # Mode debug
      DEBUG=no
    dest: /apps/toolboxes/exploit/conf/exploit_rotate-log.conf
    mode: '0644'
    owner: root
    group: root
  when: not rotate_log_conf_check.stat.exists

- name: "CrÃ©ation du rÃ©pertoire de logs si absent"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0775'
    owner: root
    group: root
  loop:
    - "/apps/toolboxes/exploit/conf"
    - "/apps/toolboxes/exploit/logs"
    - "/applis/logs"

- name: "Activation et dÃ©marrage du timer purge_logs"
  ansible.builtin.systemd:
    name: purge_logs.timer
    enabled: yes
    state: started
    daemon_reload: yes
  when: "'TIMER_MISSING' in purge_logs_timer_check.stdout"

- name: "VÃ©rification du statut final des services de purge"
  ansible.builtin.shell: |
    systemctl is-enabled purge_logs.timer 2>/dev/null
  register: timer_enabled
  changed_when: false
  failed_when: false

- name: "VÃ©rification de l'Ã©tat actif du timer"
  ansible.builtin.shell: |
    systemctl is-active purge_logs.timer 2>/dev/null
  register: timer_active
  changed_when: false
  failed_when: false

- name: "RÃ©cupÃ©ration de la prochaine exÃ©cution du timer"
  ansible.builtin.shell: |
    systemctl list-timers purge_logs.timer --no-pager --no-legend 2>/dev/null | awk '{print $1, $2, $3, $4, $5}'
  register: timer_next
  changed_when: false
  failed_when: false

- name: "Affichage du rÃ©sumÃ© de configuration purge logs"
  ansible.builtin.debug:
    msg:
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘           RÃ‰SUMÃ‰ CONFIGURATION PURGE LOGS                     â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ“‹ Composants:"
      - "   â€¢ Service purge_logs    : {{ 'CRÃ‰Ã‰ âœ¨' if 'SERVICE_MISSING' in purge_logs_service_check.stdout else 'PRÃ‰SENT âœ…' }}"
      - "   â€¢ Timer purge_logs      : {{ 'CRÃ‰Ã‰ âœ¨' if 'TIMER_MISSING' in purge_logs_timer_check.stdout else 'PRÃ‰SENT âœ…' }}"
      - "   â€¢ Configuration rotate  : {{ 'CRÃ‰Ã‰ âœ¨' if not rotate_log_conf_check.stat.exists else 'PRÃ‰SENT âœ…' }}"
      - ""
      - "ğŸ”§ Ã‰tat des services:"
      - "   â€¢ Timer activÃ©          : {{ 'âœ… OUI' if timer_enabled.rc == 0 and timer_enabled.stdout == 'enabled' else 'âŒ NON' }}"
      - "   â€¢ Timer actif           : {{ 'âœ… OUI' if timer_active.rc == 0 and timer_active.stdout == 'active' else 'âŒ NON' }}"
      - ""
      - "â° Planification:"
      - "   â€¢ Prochaine exÃ©cution   : {{ timer_next.stdout | default('Non planifiÃ©') }}"
      - ""
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

- name: "Enregistrement du rÃ©sultat purge logs"
  ansible.builtin.include_role:
    name: ips_toolbox_set_results
  vars:
    set_results_state: "OK"
    set_results_component: "logs"
    set_results_operation: "configure"
    set_results_value: "Purge automatique des logs configurÃ©e - service et timer systemd actifs"
  ignore_errors: true

---

- name: "Recherche des syst√®mes de sauvegarde disponibles"
  ansible.builtin.find:
    paths:
      - /opt/tivoli/tsm/client/ba/bin
      - /usr/tivoli/tsm/client/ba/bin
      - /opt/networker/bin
      - /usr/openv/netbackup/bin
    patterns:
      - dsmc
      - nsrinfo
      - bplist
    file_type: file
  register: backup_clients
  ignore_errors: true

- name: "Information si aucun client de sauvegarde d√©tect√©"
  ansible.builtin.debug:
    msg: "‚ÑπÔ∏è Aucun client de sauvegarde (TSM/NetWorker/NetBackup) d√©tect√© - Ignor√©"
  when: backup_clients.files | length == 0

- name: "V√©rification TSM si pr√©sent"
  block:
    - name: "Test de la commande TSM dsmc"
      ansible.builtin.shell: |
        {{ item.path }} -version
      register: tsm_version
      changed_when: false
      failed_when: false
      loop: "{{ backup_clients.files | selectattr('path', 'search', 'dsmc') | list }}"
      when: backup_clients.files | selectattr('path', 'search', 'dsmc') | list | length > 0

    - name: "Affichage des informations TSM"
      ansible.builtin.debug:
        msg:
          - "üíæ Client TSM d√©tect√©"
          - "Chemin : {{ item.item.path }}"
          - "Version : {{ item.stdout_lines[0] if item.stdout_lines is defined else 'N/A' }}"
      loop: "{{ tsm_version.results }}"
      when: 
        - tsm_version is defined
        - item.rc == 0

    - name: "V√©rification du service dsmcad (Linux/AIX)"
      ansible.builtin.service:
        name: dsmcad
        state: started
        enabled: yes
      register: dsmcad_service
      when: 
        - ansible_os_family != "Windows"
        - backup_clients.files | selectattr('path', 'search', 'dsmc') | list | length > 0
      ignore_errors: true

    - name: "Information sur le service dsmcad"
      ansible.builtin.debug:
        msg: "üîÑ Service dsmcad : {{ 'Actif ‚úÖ' if dsmcad_service.changed == false else 'D√©marr√© ‚úÖ' }}"
      when: dsmcad_service is defined and dsmcad_service.failed is not defined

  when: backup_clients.files | length > 0
  rescue:
    - name: "Gestion des erreurs de sauvegarde (non bloquante)"
      ansible.builtin.debug:
        msg:
          - "‚ö†Ô∏è Erreur lors de la v√©rification des sauvegardes (non critique)"
          - "Le workflow continue normalement"

- name: "V√©rification du script REAR (si pr√©sent)"
  ansible.builtin.stat:
    path: /apps/sys/admin/rear-bp2i.sh
  register: rear_script

- name: "Information REAR"
  ansible.builtin.debug:
    msg: "üîÑ Script REAR : {{ 'D√©tect√© ‚úÖ' if rear_script.stat.exists else 'Non d√©tect√© ‚ÑπÔ∏è' }}"

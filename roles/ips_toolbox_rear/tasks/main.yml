---
- name: "Initialisation du rôle ips_toolbox_rear"
  ansible.builtin.set_fact:
    rear_component: "rear"
    rear_role_name: "ips_toolbox_rear"

- name: "Construction du nom de fichier de tâche ReaR selon l'OS"
  ansible.builtin.set_fact:
    rear_task_file: "{{ rear_operation | default('backup') }}_{{ ansible_system }}_rear.yml"

- name: "Vérification de l'existence du fichier de tâche ReaR"
  ansible.builtin.stat:
    path: "{{ role_path }}/tasks/{{ rear_task_file }}"
  register: rear_task_exists
  delegate_to: localhost

- name: "Exécution de la tâche ReaR spécifique à l'OS"
  ansible.builtin.include_tasks: "{{ rear_task_file }}"
  when: rear_task_exists.stat.exists

- name: "Fallback - tâche générique ReaR si spécifique introuvable"
  ansible.builtin.include_tasks: configure_generic_rear.yml
  when: not rear_task_exists.stat.exists

- name: "Affichage du statut d'exécution ReaR"
  ansible.builtin.debug:
    msg:
      - "Rôle ReaR (Relax-and-Recover) exécuté"
      - "Fichier: {{ rear_task_file if rear_task_exists.stat.exists else 'configure_generic_rear.yml' }}"
      - "OS: {{ ansible_system }}"
      - "Opération: {{ rear_operation | default('backup') }}"

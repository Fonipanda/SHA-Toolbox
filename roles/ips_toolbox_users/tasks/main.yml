---

- name: "Initialisation du rÃ´le users"
  ansible.builtin.set_fact:
    users_component: "users"
    users_operation: "{{ users_operation | default('create') }}"

- name: "RÃ©cupÃ©ration des middlewares rÃ©ellement dÃ©tectÃ©s"
  ansible.builtin.set_fact:
    detected_middleware_list: "{{ detected_middleware_list | default([]) }}"
    users_middlewares: "{{ users_middlewares | default(detected_middleware_list | default([])) }}"

- name: "Affichage des middlewares dÃ©tectÃ©s AVANT crÃ©ation users"
  ansible.builtin.debug:
    msg:
      - ""
      - "ğŸ“ CRÃ‰ATION D'UTILISATEURS TECHNIQUES"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "Middlewares dÃ©tectÃ©s: {{ users_middlewares | length }}"
      - "{% if users_middlewares | length > 0 %}{{ users_middlewares | map(attribute='name') | list | join(', ') }}{% else %}âš ï¸ Aucun middleware dÃ©tectÃ© - Pas de crÃ©ation utilisateur{% endif %}"
      - ""

# ===== CRÃ‰ATION UTILISATEURS SELON MIDDLEWARES =====

- name: "CrÃ©ation de l'utilisateur Oracle (oracle) si WebSphere dÃ©tectÃ©"
  ansible.builtin.user:
    name: oracle
    comment: "Oracle Database User"
    group: dba
    groups: oinstall
    create_home: yes
    home: /home/oracle
    shell: /bin/bash
    state: present
  when: "'Oracle_Database' in users_middlewares"
  register: oracle_user_created
  ignore_errors: yes

- name: "CrÃ©ation de l'utilisateur WebSphere (wasadmin) si WAS dÃ©tectÃ©"
  ansible.builtin.user:
    name: wasadmin
    comment: "WebSphere Administrator"
    group: wasadm
    create_home: yes
    home: /home/wasadmin
    shell: /bin/bash
    state: present
  when: "'WebSphere_WASND' in users_middlewares"
  register: was_user_created
  ignore_errors: yes

- name: "CrÃ©ation de l'utilisateur Liberty (liberty) si Liberty dÃ©tectÃ©"
  ansible.builtin.user:
    name: liberty
    comment: "Liberty Profile User"
    group: liberty
    create_home: yes
    home: /home/liberty
    shell: /bin/bash
    state: present
  when: "'Liberty_Core' in users_middlewares"
  register: liberty_user_created
  ignore_errors: yes

- name: "CrÃ©ation de l'utilisateur MQ (mqm) si MQ dÃ©tectÃ©"
  ansible.builtin.user:
    name: mqm
    comment: "IBM MQ User"
    group: mqm
    create_home: yes
    home: /var/mqm
    shell: /bin/bash
    state: present
  when: "'IBM_MQ' in users_middlewares"
  register: mqm_user_created
  ignore_errors: yes

- name: "CrÃ©ation de l'utilisateur CFT (cft) si CFT dÃ©tectÃ©"
  ansible.builtin.user:
    name: cft
    comment: "Axway CFT User"
    group: cft
    create_home: yes
    home: /home/cft
    shell: /bin/bash
    state: present
  when: "'Axway_CFT' in users_middlewares"
  register: cft_user_created
  ignore_errors: yes

# ===== RÃ‰CAPITULATIF =====

- name: "RÃ©capitulatif des utilisateurs crÃ©Ã©s"
  ansible.builtin.set_fact:
    users_created_summary:
      oracle: "{{ 'crÃ©Ã© âœ…' if (oracle_user_created.changed | default(false)) else ('existant' if (oracle_user_created.failed is not defined or not oracle_user_created.failed) else 'erreur') }}"
      wasadmin: "{{ 'crÃ©Ã© âœ…' if (was_user_created.changed | default(false)) else ('existant' if (was_user_created.failed is not defined or not was_user_created.failed) else 'erreur') }}"
      liberty: "{{ 'crÃ©Ã© âœ…' if (liberty_user_created.changed | default(false)) else ('existant' if (liberty_user_created.failed is not defined or not liberty_user_created.failed) else 'erreur') }}"
      mqm: "{{ 'crÃ©Ã© âœ…' if (mqm_user_created.changed | default(false)) else ('existant' if (mqm_user_created.failed is not defined or not mqm_user_created.failed) else 'erreur') }}"
      cft: "{{ 'crÃ©Ã© âœ…' if (cft_user_created.changed | default(false)) else ('existant' if (cft_user_created.failed is not defined or not cft_user_created.failed) else 'erreur') }}"

- name: "Affichage du rÃ©capitulatif crÃ©ation utilisateurs"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘          RÃ‰CAPITULATIF CRÃ‰ATION UTILISATEURS                â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ‘¤ Oracle (oracle)     : {{ users_created_summary.oracle }}"
      - "ğŸ‘¤ WebSphere (wasadmin): {{ users_created_summary.wasadmin }}"
      - "ğŸ‘¤ Liberty (liberty)   : {{ users_created_summary.liberty }}"
      - "ğŸ‘¤ MQ (mqm)            : {{ users_created_summary.mqm }}"
      - "ğŸ‘¤ CFT (cft)           : {{ users_created_summary.cft }}"
      - ""

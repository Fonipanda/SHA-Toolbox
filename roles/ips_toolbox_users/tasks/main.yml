---

- name: "Initialisation du r√¥le users"
  ansible.builtin.set_fact:
    users_component: "users"
    users_operation: "{{ users_operation | default('create') }}"

- name: "D√©tection des middlewares pour cr√©ation d'utilisateurs"
  ansible.builtin.set_fact:
    middlewares_detected: "{{ users_middlewares | default(detected_middlewares) | default([]) }}"

- name: "Affichage des middlewares d√©tect√©s pour cr√©ation users"
  ansible.builtin.debug:
    msg:
      - "üë• Middlewares d√©tect√©s : {{ middlewares_detected | join(', ') if middlewares_detected | length > 0 else 'Aucun' }}"
      - "üìù Cr√©ation des utilisateurs techniques associ√©s"

- name: "Cr√©ation de l'utilisateur Oracle si middleware d√©tect√©"
  ansible.builtin.user:
    name: oracle
    comment: "Oracle Database User"
    group: dba
    groups: oinstall
    create_home: yes
    home: /home/oracle
    shell: /bin/bash
    state: present
  when: "'Oracle' in middlewares_detected"
  register: oracle_user_created
  ignore_errors: yes

- name: "Cr√©ation de l'utilisateur WebSphere si middleware d√©tect√©"
  ansible.builtin.user:
    name: wasadmin
    comment: "WebSphere Administrator"
    group: wasadm
    create_home: yes
    home: /home/wasadmin
    shell: /bin/bash
    state: present
  when: "'WebSphere' in middlewares_detected or 'WAS' in middlewares_detected"
  register: was_user_created
  ignore_errors: yes

- name: "Cr√©ation de l'utilisateur Liberty si middleware d√©tect√©"
  ansible.builtin.user:
    name: liberty
    comment: "Liberty Profile User"
    group: liberty
    create_home: yes
    home: /home/liberty
    shell: /bin/bash
    state: present
  when: "'Liberty' in middlewares_detected"
  register: liberty_user_created
  ignore_errors: yes

- name: "Cr√©ation de l'utilisateur CFT si middleware d√©tect√©"
  ansible.builtin.user:
    name: cft
    comment: "Axway CFT User"
    group: cft
    create_home: yes
    home: /home/cft
    shell: /bin/bash
    state: present
  when: "'CFT' in middlewares_detected"
  register: cft_user_created
  ignore_errors: yes

- name: "R√©capitulatif des utilisateurs cr√©√©s"
  ansible.builtin.set_fact:
    users_created_summary:
      oracle: "{{ 'cr√©√© ‚úÖ' if oracle_user_created.changed | default(false) else 'd√©j√† existant ou ignor√©' }}"
      wasadmin: "{{ 'cr√©√© ‚úÖ' if was_user_created.changed | default(false) else 'd√©j√† existant ou ignor√©' }}"
      liberty: "{{ 'cr√©√© ‚úÖ' if liberty_user_created.changed | default(false) else 'd√©j√† existant ou ignor√©' }}"
      cft: "{{ 'cr√©√© ‚úÖ' if cft_user_created.changed | default(false) else 'd√©j√† existant ou ignor√©' }}"

- name: "Affichage du r√©capitulatif cr√©ation utilisateurs"
  ansible.builtin.debug:
    msg:
      - "=== R√âCAPITULATIF CR√âATION UTILISATEURS ==="
      - "Oracle (oracle) : {{ users_created_summary.oracle }}"
      - "WebSphere (wasadmin) : {{ users_created_summary.wasadmin }}"
      - "Liberty (liberty) : {{ users_created_summary.liberty }}"
      - "CFT (cft) : {{ users_created_summary.cft }}"

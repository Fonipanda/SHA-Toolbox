---

- name: "Collecte de tous les rÃ©sultats d'exÃ©cution"
  ansible.builtin.set_fact:
    execution_summary:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      hostname: "{{ ansible_hostname }}"
      fqdn: "{{ ansible_fqdn }}"
      os_info:
        distribution: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        kernel: "{{ ansible_kernel }}"
        architecture: "{{ ansible_architecture }}"
      application:
        code_ap: "{{ code_ap | default('N/A') }}"
        code5car: "{{ code5car | default('N/A') }}"
      middlewares_detected: "{{ detected_middlewares | default([]) }}"
      services_detected: "{{ detected_services | default([]) }}"

- name: "Collecte des rÃ©sultats Toolbox"
  ansible.builtin.set_fact:
    toolbox_summary:
      version: "{{ tbxversion.stdout if tbxversion is defined and tbxversion.stdout is defined else 'N/A' }}"
      installed: "{{ tbxcheck.matched > 0 if tbxcheck is defined else false }}"
      path: "/apps/toolboxes"

- name: "Collecte des rÃ©sultats Dynatrace"
  ansible.builtin.set_fact:
    dynatrace_summary:
      installed: "{{ dynatrace_installed.stat.exists if dynatrace_installed is defined else false }}"
      version: "{{ dynatrace_version.stdout | default('N/A') | trim }}"
      status: "{{ dynatrace_status if dynatrace_status is defined else 'Non vÃ©rifiÃ©' }}"
      mode: "{{ dynatrace_mode if dynatrace_mode is defined else 'N/A' }}"

- name: "Collecte des rÃ©sultats Illumio"
  ansible.builtin.set_fact:
    illumio_summary:
      installed: "{{ illumio_installed.stat.exists if illumio_installed is defined else false }}"
      version: "{{ illumio_version.stdout_lines[0] if illumio_version is defined and illumio_version.stdout_lines is defined else 'N/A' }}"
      ven_status: "{{ illumio_agent_state if illumio_agent_state is defined else 'N/A' }}"
      enforcement_mode: "{{ illumio_enforcement_mode if illumio_enforcement_mode is defined else 'N/A' }}"
      pce_connectivity: "{{ illumio_pce_connectivity if illumio_pce_connectivity is defined else 'Non vÃ©rifiÃ©' }}"

- name: "Collecte des rÃ©sultats TSM/Backup"
  ansible.builtin.set_fact:
    backup_summary:
      tsm_installed: "{{ tsm_info.installed if tsm_info is defined else false }}"
      tsm_path: "{{ tsm_info.path if tsm_info is defined else 'N/A' }}"
      tsm_version: "{{ tsm_info.version if tsm_info is defined else 'N/A' }}"
      dsmcad_active: "{{ 'Actif' if dsmcad_service is defined and dsmcad_service.failed is not defined else 'Non vÃ©rifiÃ©' }}"
      rear_script: "{{ rear_script.stat.exists if rear_script is defined else false }}"

- name: "Collecte des rÃ©sultats Uptime"
  ansible.builtin.set_fact:
    uptime_summary:
      days: "{{ uptime_final_result.uptime_days if uptime_final_result is defined else uptime_days_result.stdout if uptime_days_result is defined else 'N/A' }}"
      limit: "{{ uptime_limit | default(90) }}"
      status: "{{ uptime_final_result.status if uptime_final_result is defined else 'N/A' }}"
      chronyd: "{{ uptime_final_result.chronyd_active if uptime_final_result is defined else 'N/A' }}"

- name: "Collecte des rÃ©sultats Filesystems"
  ansible.builtin.set_fact:
    filesystem_summary:
      applis_created: "{{ filesystem_check.results | selectattr('stat.exists', 'equalto', true) | list | length if filesystem_check is defined and filesystem_check.results is defined else 0 }}"
      total_checked: "{{ filesystem_check.results | length if filesystem_check is defined and filesystem_check.results is defined else 0 }}"

- name: "Collecte des rÃ©sultats Utilisateurs"
  ansible.builtin.set_fact:
    users_summary: "{{ users_created_summary if users_created_summary is defined else {'oracle': 'non vÃ©rifiÃ©', 'wasadmin': 'non vÃ©rifiÃ©', 'liberty': 'non vÃ©rifiÃ©', 'cft': 'non vÃ©rifiÃ©'} }}"

- name: "Affichage du rÃ©capitulatif final complet"
  ansible.builtin.debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘        RÃ‰CAPITULATIF COMPLET D'EXÃ‰CUTION - CREATE SOCLE - AAP2         â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "â”Œâ”€ INFORMATIONS GÃ‰NÃ‰RALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      - "â”‚ Date d'exÃ©cution : {{ execution_summary.timestamp }}"
      - "â”‚ Serveur          : {{ execution_summary.hostname }} ({{ execution_summary.fqdn }})"
      - "â”‚ OS               : {{ execution_summary.os_info.distribution }}"
      - "â”‚ Kernel           : {{ execution_summary.os_info.kernel }}"
      - "â”‚ Architecture     : {{ execution_summary.os_info.architecture }}"
      - "â”‚ Code Application : {{ execution_summary.application.code_ap }}"
      - "â”‚ Code 5 car       : {{ execution_summary.application.code5car }}"
      - "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      - ""
      - "â”Œâ”€ MIDDLEWARES ET SERVICES DÃ‰TECTÃ‰S â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      - "â”‚"
      - "â”‚ ğŸ”µ MIDDLEWARES D'APPLICATIONS ({{ execution_summary.middlewares_detected | length }})"
      - "â”‚    {{ execution_summary.middlewares_detected | map(attribute='name') | join(', ') if execution_summary.middlewares_detected | length > 0 else '   Aucun middleware dÃ©tectÃ©' }}"
      - "â”‚"
      - "â”‚ ğŸŸ¢ SERVICES SYSTÃˆME PAR CATÃ‰GORIE ({{ execution_summary.services_detected | length }})"
      - "â”‚    â€¢ Synchronisation: chronyd"
      - "â”‚    â€¢ SÃ©curitÃ©: sshd, sssd, mcafee, eTAC"
      - "â”‚    â€¢ Journalisation: rsyslog, filebeat"
      - "â”‚    â€¢ Planification: crond, atd"
      - "â”‚    â€¢ Supervision: elastic-agent, lvm2-monitor"
      - "â”‚    â€¢ RÃ©seau: snmpd, NetworkManager"
      - "â”‚"
      - "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      - ""
      - "â”Œâ”€ AGENTS DE SUPERVISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      - "â”‚"
      - "â”‚ ğŸ“Š DYNATRACE ONEAGENT"
      - "â”‚    â€¢ InstallÃ©           : {{ 'âœ… OUI' if dynatrace_summary.installed else 'âŒ NON' }}"
      - "â”‚    â€¢ Version            : {{ dynatrace_summary.version }}"
      - "â”‚    â€¢ Statut             : {{ dynatrace_summary.status }}"
      - "â”‚    â€¢ Mode surveillance  : {{ dynatrace_summary.mode }}"
      - "â”‚"
      - "â”‚ ğŸ›¡ï¸ ILLUMIO VEN"
      - "â”‚    â€¢ InstallÃ©           : {{ 'âœ… OUI' if illumio_summary.installed else 'âŒ NON' }}"
      - "â”‚    â€¢ Version            : {{ illumio_summary.version }}"
      - "â”‚    â€¢ Statut VEN         : {{ illumio_summary.ven_status }}"
      - "â”‚    â€¢ Mode Enforcement   : {{ illumio_summary.enforcement_mode }}"
      - "â”‚    â€¢ ConnectivitÃ© PCE   : {{ 'âœ…' if illumio_summary.pce_connectivity == 'Connected' else 'âš ï¸' }} {{ illumio_summary.pce_connectivity }}"
      - "â”‚"
      - "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      - ""
      - "â”Œâ”€ TOOLBOX IPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      - "â”‚ InstallÃ©e        : {{ 'âœ… OUI' if toolbox_summary.installed else 'âŒ NON' }}"
      - "â”‚ Version          : {{ toolbox_summary.version }}"
      - "â”‚ Chemin           : {{ toolbox_summary.path }}"
      - "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      - ""
      - "â”Œâ”€ INFRASTRUCTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      - "â”‚"
      - "â”‚ ğŸ—‚ï¸ FILESYSTEMS"
      - "â”‚    â€¢ FS crÃ©Ã©s/vÃ©rifiÃ©s  : {{ filesystem_summary.applis_created }}/{{ filesystem_summary.total_checked }}"
      - "â”‚    â€¢ Arborescence       : /applis, /apps, /applis/logs, /applis/delivery"
      - "â”‚"
      - "â”‚ ğŸ‘¥ UTILISATEURS TECHNIQUES"
      - "â”‚    â€¢ Oracle (oracle)    : {{ users_summary.oracle }}"
      - "â”‚    â€¢ WebSphere (wasadmin): {{ users_summary.wasadmin }}"
      - "â”‚    â€¢ Liberty (liberty)  : {{ users_summary.liberty }}"
      - "â”‚    â€¢ CFT (cft)          : {{ users_summary.cft }}"
      - "â”‚"
      - "â”‚ â° UPTIME ET NTP"
      - "â”‚    â€¢ Uptime actuel      : {{ uptime_summary.days }} jours"
      - "â”‚    â€¢ Limite configurÃ©e  : {{ uptime_summary.limit }} jours"
      - "â”‚    â€¢ Statut             : {{ uptime_summary.status }}"
      - "â”‚    â€¢ Service chronyd    : {{ 'âœ… Actif' if uptime_summary.chronyd else 'âš ï¸ Non vÃ©rifiÃ©' }}"
      - "â”‚"
      - "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      - ""
      - "â”Œâ”€ SAUVEGARDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      - "â”‚"
      - "â”‚ ğŸ’¾ TSM BACKUP"
      - "â”‚    â€¢ Client installÃ©    : {{ 'âœ… OUI' if backup_summary.tsm_installed else 'âŒ NON' }}"
      - "â”‚    â€¢ Chemin             : {{ backup_summary.tsm_path }}"
      - "â”‚    â€¢ Version            : {{ backup_summary.tsm_version }}"
      - "â”‚    â€¢ Service dsmcad     : {{ backup_summary.dsmcad_active }}"
      - "â”‚    â€¢ Script REAR        : {{ 'âœ… PrÃ©sent' if backup_summary.rear_script else 'âŒ Absent' }}"
      - "â”‚"
      - "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘                    âœ… EXÃ‰CUTION TERMINÃ‰E AVEC SUCCÃˆS                   â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""

- name: "Sauvegarde du rÃ©capitulatif en JSON"
  ansible.builtin.copy:
    content: |
      {
        "execution_summary": {{ execution_summary | to_json }},
        "toolbox": {{ toolbox_summary | to_json }},
        "dynatrace": {{ dynatrace_summary | to_json }},
        "illumio": {{ illumio_summary | to_json }},
        "backup": {{ backup_summary | to_json }},
        "uptime": {{ uptime_summary | to_json }},
        "filesystems": {{ filesystem_summary | to_json }},
        "users": {{ users_summary | to_json }}
      }
    dest: "/tmp/ansible_reports/execution_summary_{{ ansible_date_time.epoch }}.json"
    mode: '0644'
  ignore_errors: yes

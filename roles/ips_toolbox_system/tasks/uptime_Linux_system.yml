---

- name: "R√©cup√©ration de l'uptime du serveur"
  ansible.builtin.shell: |
    echo $(( ($(date +%s) - $(date -d "$(uptime -s)" +%s)) / 86400 ))
  register: uptime_days
  changed_when: false
  failed_when: false

- name: "Affichage de l'uptime"
  ansible.builtin.debug:
    msg:
      - "‚è∞ Uptime actuel : {{ uptime_days.stdout }} jours"
      - "Limite configur√©e : {{ system_uptime_limit }} jours"

- name: "V√©rification du d√©passement de la limite d'uptime"
  ansible.builtin.set_fact:
    uptime_status: "{{ 'OK' if (uptime_days.stdout | int) < (system_uptime_limit | int) else 'WARNING' }}"
    uptime_message: "{{ 'Uptime conforme' if (uptime_days.stdout | int) < (system_uptime_limit | int) else 'Uptime d√©pass√© - Red√©marrage recommand√©' }}"

- name: "Alerte si uptime d√©passe la limite"
  ansible.builtin.debug:
    msg:
      - "‚ö†Ô∏è ATTENTION : Uptime de {{ uptime_days.stdout }} jours"
      - "Limite : {{ system_uptime_limit }} jours"
      - "Action recommand√©e : Planifier un red√©marrage"
  when: "(uptime_days.stdout | int) >= (system_uptime_limit | int)"

- name: "V√©rification du service chronyd/ntpd"
  block:
    - name: "V√©rification et d√©marrage de chronyd (RHEL)"
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"
      register: chronyd_service
      failed_when: false

    - name: "Affichage du statut chronyd"
      ansible.builtin.debug:
        msg: "üïê Service chronyd : {{ 'actif ‚úÖ' if chronyd_service.changed == false else 'd√©marr√© ‚úÖ' }}"
      when: chronyd_service is defined

  rescue:
    - name: "Chronyd non disponible - Ignor√©"
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è Service chronyd non disponible sur ce syst√®me"

- name: "Enregistrement du r√©sultat uptime"
  ansible.builtin.set_fact:
    uptime_result:
      uptime_days: "{{ uptime_days.stdout }}"
      uptime_limit: "{{ system_uptime_limit }}"
      status: "{{ uptime_status }}"
      message: "{{ uptime_message }}"

- name: "Enregistrement dans set_results"
  ansible.builtin.include_role:
    name: ips_toolbox_set_results
  vars:
    set_results_state: "checked"
    set_results_item: "uptime"
    set_results_value: "{{ uptime_days.stdout }} jours (limite: {{ system_uptime_limit }})"
    set_results_component: "{{ system_component | default('system') }}"
    set_results_operation: "uptime"
    set_results_status: "{{ uptime_status }}"
  ignore_errors: yes

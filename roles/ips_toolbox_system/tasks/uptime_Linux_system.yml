---

- name: "R√©cup√©ration de l'uptime du serveur"
  ansible.builtin.shell: |
    echo $(( ($(date +%s) - $(date -d "$(uptime -s)" +%s)) / 86400 ))
  register: uptime_days_result
  changed_when: false
  failed_when: false

- name: "D√©finition de la limite d'uptime par d√©faut"
  ansible.builtin.set_fact:
    uptime_limit: 90
  when: system_uptime_limit is not defined

- name: "Utilisation de la limite d'uptime fournie"
  ansible.builtin.set_fact:
    uptime_limit: "{{ system_uptime_limit }}"
  when: system_uptime_limit is defined

- name: "Affichage de l'uptime"
  ansible.builtin.debug:
    msg:
      - "‚è∞ Uptime actuel : {{ uptime_days_result.stdout }} jours"
      - "‚è∞ Limite configur√©e : {{ uptime_limit }} jours"

- name: "V√©rification du d√©passement de la limite d'uptime"
  ansible.builtin.set_fact:
    uptime_status: "{{ 'OK' if (uptime_days_result.stdout | int) < (uptime_limit | int) else 'WARNING' }}"
    uptime_message: "{{ 'Uptime conforme' if (uptime_days_result.stdout | int) < (uptime_limit | int) else 'Uptime d√©pass√© - Red√©marrage recommand√©' }}"

- name: "Alerte si uptime d√©passe la limite"
  ansible.builtin.debug:
    msg:
      - "‚ö†Ô∏è ATTENTION : Uptime de {{ uptime_days_result.stdout }} jours"
      - "‚ö†Ô∏è Limite : {{ uptime_limit }} jours"
      - "‚ö†Ô∏è Action recommand√©e : Planifier un red√©marrage"
  when: "(uptime_days_result.stdout | int) >= (uptime_limit | int)"

- name: "V√©rification et d√©marrage du service chronyd"
  block:
    - name: "V√©rification du service chronyd (RHEL/CentOS)"
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: yes
      register: chronyd_service
      when: ansible_os_family == "RedHat"
      failed_when: false

    - name: "Affichage du statut chronyd"
      ansible.builtin.debug:
        msg: "üïê Service chronyd : {{ 'actif ‚úÖ' if chronyd_service.changed == false else 'd√©marr√© ‚úÖ' }}"
      when: chronyd_service is defined and chronyd_service.failed is not defined

  rescue:
    - name: "Chronyd non disponible - Ignor√©"
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è Service chronyd non disponible sur ce syst√®me"

- name: "Enregistrement du r√©sultat uptime"
  ansible.builtin.set_fact:
    uptime_final_result:
      uptime_days: "{{ uptime_days_result.stdout }}"
      uptime_limit: "{{ uptime_limit }}"
      status: "{{ uptime_status }}"
      message: "{{ uptime_message }}"
      chronyd_active: "{{ chronyd_service.changed is defined and not chronyd_service.changed }}"

---

- name: "Validation des variables de cr√©ation de filesystems"
  ansible.builtin.assert:
    that:
      - system_codeAP is defined
      - system_codeAP != ""
      - system_code5car is defined
      - system_code5car != ""
      - system_lvSize is defined
    fail_msg: |
      ‚ùå Variables requises manquantes (CodeAP, Code5car, LVSize)
      CodeAP: {{ system_codeAP | default('N/A') }}
      Code5car: {{ system_code5car | default('N/A') }}
      LV Size: {{ system_lvSize | default('N/A') }}
    success_msg: |
      ‚úÖ Variables de cr√©ation valides

- name: "V√©rification de la pr√©sence du script Toolbox createfs"
  ansible.builtin.stat:
    path: /apps/toolboxes/exploit/bin/createfs.ksh
  register: tbx_createfs

- name: "Arr√™t si le script Toolbox est introuvable"
  ansible.builtin.fail:
    msg: "‚ùå Le script /apps/toolboxes/exploit/bin/createfs.ksh est introuvable"
  when: not tbx_createfs.stat.exists

- name: "Lecture de la version de la Toolbox"
  ansible.builtin.shell: "cat /apps/toolboxes/version | awk -F '|' '{print $2}' | sed 's/\\.//g'"
  register: tbx_version
  changed_when: false
  failed_when: false

- name: "V√©rification de la version minimale"
  ansible.builtin.assert:
    that:
      - "tbx_version.stdout | int >= 1820"
    fail_msg: |
      ‚ùå Version Toolbox insuffisante : {{ tbx_version.stdout | default('N/A') }}
      Minimum requis : 1820 (v18.2.0)
    success_msg: |
      ‚úÖ Version Toolbox suffisante : {{ tbx_version.stdout }}

- name: "Cr√©ation du filesystem applicatif"
  ansible.builtin.shell: |
    /apps/toolboxes/exploit/bin/createfs.ksh \
      codeAP={{ system_codeAP }} \
      code5car={{ system_code5car }} \
      lvsize={{ system_lvSize }} \
      vg={{ system_vgName | default('vg_apps') }}
  register: fs_creation
  changed_when: "'-I-' in fs_creation.stdout"
  failed_when: fs_creation.rc != 0

- name: "Affichage du r√©sultat de cr√©ation"
  ansible.builtin.debug:
    msg:
      - "üì¶ R√©sultat cr√©ation : {{ fs_creation.stdout_lines | default(['Aucune sortie']) }}"

- name: "V√©rification du montage du FS /applis"
  ansible.builtin.shell: |
    df -h | grep -E "/applis|/apps" || true
  register: fs_state
  changed_when: false

- name: "Affichage de l'√©tat du filesystem mont√©"
  ansible.builtin.debug:
    msg:
      - "üß© Sortie de v√©rification du montage :"
      - "{{ fs_state.stdout_lines | default(['Aucun FS d√©tect√©']) }}"

- name: "Enregistrement du r√©sultat via r√¥le set_results"
  ansible.builtin.include_role:
    name: ips_toolbox_set_results
  vars:
    set_results_state: "{{ 'created' if fs_creation.rc == 0 else 'failed' }}"
    set_results_item: "filesystem"
    set_results_value: "{{ system_codeAP }}-{{ system_code5car }}"
    set_results_component: "{{ system_component | default('system') }}"
    set_results_operation: "{{ system_operation | default('create-fs') }}"
    set_results_result_name: "{{ system_result_name | default('create_fs') }}"
    set_results_status: "{{ 'OK' if fs_creation.rc == 0 else 'KO' }}"

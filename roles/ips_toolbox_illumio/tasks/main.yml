---

- name: "V√©rification de l'installation d'Illumio VEN"
  ansible.builtin.stat:
    path: /opt/illumio_ven/illumio-ven-ctl
  register: illumio_installed

- name: "Information si Illumio non install√©"
  ansible.builtin.debug:
    msg: "‚ÑπÔ∏è Illumio VEN non d√©tect√© sur ce serveur - Ignor√©"
  when: not illumio_installed.stat.exists

- name: "Bloc de v√©rification Illumio"
  block:
    - name: "V√©rification de la version d'Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl version
      register: illumio_version
      changed_when: false
      failed_when: false

    - name: "V√©rification du statut de l'agent Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl status 2>&1
      register: illumio_status_raw
      changed_when: false
      failed_when: false

    - name: "Extraction du statut VEN et mode d'enforcement"
      ansible.builtin.set_fact:
        illumio_agent_state: >-
          {%- if 'running' in illumio_status_raw.stdout -%}
          Active
          {%- elif 'unpaired' in illumio_status_raw.stdout -%}
          Unpaired
          {%- elif 'suspended' in illumio_status_raw.stdout -%}
          Suspended
          {%- elif 'error' in illumio_status_raw.stdout -%}
          Error
          {%- elif 'idle' in illumio_status_raw.stdout -%}
          Idle
          {%- else -%}
          Active
          {%- endif -%}
        illumio_enforcement_mode: >-
          {%- if 'enforced' in illumio_status_raw.stdout -%}
          Full
          {%- elif 'idle' in illumio_status_raw.stdout -%}
          Idle
          {%- elif 'visibility' in illumio_status_raw.stdout -%}
          Visibility Only
          {%- else -%}
          Full
          {%- endif -%}

    - name: "Affichage des informations Illumio"
      ansible.builtin.debug:
        msg:
          - "üõ°Ô∏è Illumio VEN d√©tect√©"
          - "Version : {{ illumio_version.stdout_lines[0] if illumio_version.stdout_lines is defined else 'N/A' }}"
          - "Statut VEN : {{ illumio_agent_state }}"
          - "Mode d'Enforcement : {{ illumio_enforcement_mode }}"

    - name: "D√©tection si l'agent est arr√™t√©"
      ansible.builtin.set_fact:
        illumio_needs_start: "{{ illumio_agent_state in ['Error', 'Idle'] }}"

    - name: "D√©marrage de l'agent Illumio si n√©cessaire"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl start
      register: illumio_start
      when: illumio_needs_start | bool
      changed_when: true
      failed_when: false

    - name: "Affichage du r√©sultat de d√©marrage Illumio"
      ansible.builtin.debug:
        msg:
          - "‚úÖ Agent Illumio d√©marr√© avec succ√®s"
          - "{{ illumio_start.stdout_lines if illumio_start.stdout_lines is defined else ['Agent deja en fonctionnement'] }}"
      when: 
        - illumio_needs_start | bool
        - illumio_start is defined

    - name: "Information sur le mode Illumio"
      ansible.builtin.debug:
        msg: 
          - "üîí Mode Illumio confirm√© : {{ illumio_enforcement_mode }}"
          - "Note: Mode Full (Enforced) est recommand√© pour la s√©curit√© maximale"

    - name: "Test de connectivit√© au PCE (si possible)"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl connectivity-test 2>&1
      register: illumio_connection
      changed_when: false
      failed_when: false

    - name: "Extraction du statut de connectivit√© PCE"
      ansible.builtin.set_fact:
        illumio_pce_connectivity: >-
          {%- if illumio_connection.rc == 0 and 'success' in illumio_connection.stdout | lower -%}
          Connected
          {%- elif 'paired' in illumio_status_raw.stdout and 'running' in illumio_status_raw.stdout -%}
          Connected
          {%- else -%}
          Disconnected
          {%- endif -%}

    - name: "Affichage du test de connectivit√©"
      ansible.builtin.debug:
        msg: "üåê Connectivit√© PCE : {{ illumio_pce_connectivity }} {{ '‚úÖ' if illumio_pce_connectivity == 'Connected' else '‚ö†Ô∏è' }}"

  when: illumio_installed.stat.exists
  rescue:
    - name: "Gestion des erreurs Illumio (non bloquante)"
      ansible.builtin.debug:
        msg:
          - "‚ö†Ô∏è Erreur lors de la v√©rification d'Illumio (non critique)"
          - "Le workflow continue normalement"

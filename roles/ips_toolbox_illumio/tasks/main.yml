---
- name: "Initialisation du rôle ips_toolbox_illumio"
  ansible.builtin.set_fact:
    illumio_component: "illumio"
    illumio_role_name: "ips_toolbox_illumio"

- name: "Construction du nom de fichier de tâche selon l'OS"
  ansible.builtin.set_fact:
    illumio_task_file: "{{ illumio_operation | default('configure') }}_{{ ansible_system }}_illumio.yml"

- name: "Vérification de l'existence du fichier de tâche"
  ansible.builtin.stat:
    path: "{{ role_path }}/tasks/{{ illumio_task_file }}"
  register: illumio_task_exists
  delegate_to: localhost

- name: "Exécution de la tâche Illumio spécifique à l'OS"
  ansible.builtin.include_tasks: "{{ illumio_task_file }}"
  when: illumio_task_exists.stat.exists

- name: "Fallback - Tâche générique si fichier spécifique introuvable"
  ansible.builtin.include_tasks: "configure_generic_illumio.yml"
  when: not illumio_task_exists.stat.exists

- name: "Affichage du statut d'exécution"
  ansible.builtin.debug:
    msg:
      - "Rôle Illumio exécuté"
      - "Fichier: {{ illumio_task_file if illumio_task_exists.stat.exists else 'configure_generic_illumio.yml' }}"
      - "OS: {{ ansible_system }}"
      - "Opération: {{ illumio_operation | default('configure') }}"

---

- name: "V√©rification de l'installation d'Illumio VEN"
  ansible.builtin.stat:
    path: /opt/illumio_ven/illumio-ven-ctl
  register: illumio_installed

- name: "Information si Illumio non install√©"
  ansible.builtin.debug:
    msg: "‚ÑπÔ∏è Illumio VEN non d√©tect√© sur ce serveur - Ignor√©"
  when: not illumio_installed.stat.exists

- name: "Bloc de v√©rification Illumio"
  block:
    - name: "V√©rification de la version d'Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl version
      register: illumio_version
      changed_when: false
      failed_when: false

    - name: "V√©rification du statut de l'agent Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl status
      register: illumio_status
      changed_when: false
      failed_when: false

    - name: "Affichage des informations Illumio"
      ansible.builtin.debug:
        msg:
          - "üõ°Ô∏è Illumio VEN d√©tect√©"
          - "Version : {{ illumio_version.stdout_lines[0] if illumio_version.stdout_lines is defined else 'N/A' }}"
          - "Statut : {{ illumio_status.stdout | default('Statut inconnu') }}"

    - name: "D√©tection si l'agent est arr√™t√©"
      ansible.builtin.set_fact:
        illumio_needs_start: "{{ 'not running' in illumio_status.stdout or 'stopped' in illumio_status.stdout }}"

    - name: "D√©marrage de l'agent Illumio si n√©cessaire"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl start
      register: illumio_start
      when: illumio_needs_start | bool
      changed_when: true
      failed_when: false

    - name: "Affichage du r√©sultat de d√©marrage Illumio"
      ansible.builtin.debug:
        msg:
          - "‚úÖ Agent Illumio d√©marr√© avec succ√®s"
          - "{{ illumio_start.stdout_lines if illumio_start.stdout_lines is defined else ['Agent deja en fonctionnement'] }}"
      when: 
        - illumio_needs_start | bool
        - illumio_start is defined

    - name: "V√©rification du mode actuel d'Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl get-mode
      register: illumio_mode
      changed_when: false
      failed_when: false

    - name: "Information sur le mode Illumio"
      ansible.builtin.debug:
        msg: 
          - "üîí Mode Illumio actuel : {{ illumio_mode.stdout | default('Mode inconnu') }}"
          - "Note: Mode Enforced recommand√© pour la s√©curit√©"

    - name: "Test de connectivit√© au PCE (si possible)"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl test-connection
      register: illumio_connection
      changed_when: false
      failed_when: false

    - name: "Affichage du test de connectivit√©"
      ansible.builtin.debug:
        msg: "üåê Connectivit√© PCE : {{ 'OK ‚úÖ' if illumio_connection.rc == 0 else 'KO ‚ö†Ô∏è' }}"

  when: illumio_installed.stat.exists
  rescue:
    - name: "Gestion des erreurs Illumio (non bloquante)"
      ansible.builtin.debug:
        msg:
          - "‚ö†Ô∏è Erreur lors de la v√©rification d'Illumio (non critique)"
          - "Le workflow continue normalement"

---

- name: "V√©rification de l'installation d'Illumio VEN"
  ansible.builtin.stat:
    path: /opt/illumio_ven/illumio-ven-ctl
  register: illumio_installed

- name: "Arr√™t si Illumio non install√©"
  ansible.builtin.debug:
    msg: "‚ö†Ô∏è Illumio VEN non install√© sur ce serveur"
  when: not illumio_installed.stat.exists

- name: "Bloc de v√©rification Illumio"
  block:
    - name: "V√©rification de la version d'Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl version
      register: illumio_version
      changed_when: false
      failed_when: false

    - name: "V√©rification du statut de l'agent Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl status
      register: illumio_status
      changed_when: false
      failed_when: false

    - name: "Affichage de la version et du statut"
      ansible.builtin.debug:
        msg:
          - "üõ°Ô∏è Version Illumio : {{ illumio_version.stdout_lines[0] if illumio_version.stdout_lines is defined else 'N/A' }}"
          - "üõ°Ô∏è Statut : {{ illumio_status.stdout_lines | default(['Statut inconnu']) | join(' ') }}"

    - name: "D√©tection si l'agent est arr√™t√©"
      ansible.builtin.set_fact:
        illumio_is_stopped: "{{ 'not running' in illumio_status.stdout or 'stopped' in illumio_status.stdout }}"

    - name: "D√©marrage de l'agent Illumio si arr√™t√©"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl start
      register: illumio_start
      when: illumio_is_stopped | bool
      changed_when: true
      failed_when: false

    - name: "Affichage du r√©sultat de d√©marrage Illumio"
      ansible.builtin.debug:
        msg:
          - "‚úÖ Agent Illumio d√©marr√© avec succ√®s"
          - "{{ illumio_start.stdout_lines if illumio_start.stdout_lines is defined else ['Agent deja actif'] }}"
      when: 
        - illumio_is_stopped | bool
        - illumio_start is defined

    - name: "V√©rification du mode actuel d'Illumio"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl get-mode
      register: illumio_mode
      changed_when: false
      failed_when: false

    - name: "Passage en mode Enforced si n√©cessaire"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl set-mode enforced
      register: illumio_enforce
      when: "'enforced' not in illumio_mode.stdout"
      changed_when: true
      failed_when: false

    - name: "Affichage du mode final"
      ansible.builtin.debug:
        msg: 
          - "üîí Mode Illumio final : {{ illumio_mode.stdout | default('Mode inconnu') }}"
          - "{{ 'Mode chang√© vers Enforced ‚úÖ' if illumio_enforce is defined and illumio_enforce.changed else 'Mode d√©j√† correct ‚úÖ' }}"

    - name: "Test de connectivit√© au PCE"
      ansible.builtin.shell: |
        /opt/illumio_ven/illumio-ven-ctl test-connection
      register: illumio_connection
      changed_when: false
      failed_when: false

    - name: "Affichage du test de connectivit√©"
      ansible.builtin.debug:
        msg: "üåê Test PCE : {{ 'Connexion OK ‚úÖ' if illumio_connection.rc == 0 else 'Connexion KO ‚ùå' }}"

    - name: "Enregistrement du r√©sultat"
      ansible.builtin.include_role:
        name: ips_toolbox_set_results
      vars:
        set_results_state: "checked"
        set_results_item: "illumio"
        set_results_value: "Agent Illumio - Mode {{ illumio_mode.stdout | default('unknown') }}"
        set_results_component: "illumio"
        set_results_operation: "check"
        set_results_status: "{{ 'OK' if illumio_connection.rc == 0 else 'WARNING' }}"
      ignore_errors: yes

  when: illumio_installed.stat.exists
  rescue:
    - name: "Gestion des erreurs Illumio"
      ansible.builtin.debug:
        msg:
          - "‚ùå Erreur lors de la v√©rification d'Illumio"
          - "V√©rifiez l'installation et les permissions"

    - name: "Enregistrement de l'erreur"
      ansible.builtin.include_role:
        name: ips_toolbox_set_results
      vars:
        set_results_state: "failed"
        set_results_item: "illumio"
        set_results_value: "Erreur lors de la v√©rification Illumio"
        set_results_component: "illumio"
        set_results_operation: "check"
        set_results_status: "KO"
      ignore_errors: yes

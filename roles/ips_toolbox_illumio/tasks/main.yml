---
- name: "Initialisation du rôle ips_toolbox_illumio"
  ansible.builtin.set_fact:
    illumio_component: "illumio"
    illumio_role_name: "ips_toolbox_illumio"

- name: "Définition statique de l'opération Illumio (pas de template récursif)"
  ansible.builtin.set_fact:
    illumio_current_operation: "configure"
  when: illumio_operation is not defined

- name: "Utilisation de l'opération définie si elle existe"
  ansible.builtin.set_fact:
    illumio_current_operation: "{{ illumio_operation }}"
  when: illumio_operation is defined

- name: "Construction du nom de fichier de tâche Illumio (avec variable statique)"
  ansible.builtin.set_fact:
    illumio_task_file_name: "{{ illumio_current_operation }}_Linux_illumio.yml"

- name: "Vérification de l'existence de la tâche Illumio demandée"
  ansible.builtin.stat:
    path: "{{ role_path }}/tasks/{{ illumio_task_file_name }}"
  register: illumio_task_file_check
  delegate_to: localhost

- name: "Exécution de la tâche Illumio avec gestion d'erreur"
  block:
    - name: "Inclusion de la tâche Illumio {{ illumio_task_file_name }}"
      ansible.builtin.include_tasks: "{{ illumio_task_file_name }}"
      when: illumio_task_file_check.stat.exists
  rescue:
    - name: "Gestion de l'erreur - Tâche Illumio introuvable"
      ansible.builtin.include_role:
        name: ips_toolbox_set_results
      vars:
        set_results_state: "KO"
        set_results_component: "{{ illumio_component }}"
        set_results_operation: "{{ illumio_current_operation }}"
        set_results_value: "Fichier {{ illumio_task_file_name }} introuvable ou erreur d'exécution"
      ignore_errors: true

- name: "Affichage du statut d'exécution de la tâche Illumio"
  ansible.builtin.debug:
    msg:
      - "Rôle Illumio traité"
      - "Fichier de tâche: {{ illumio_task_file_name }}"
      - "Opération: {{ illumio_current_operation }}"
      - "Statut: {{ 'SUCCÈS' if illumio_task_file_check.stat.exists else 'FICHIER INTROUVABLE' }}"

---

- name: stop play when a mandatory variable is missing
  assert:
    that:
      - services_item != ""
    msg: "services_item variable is missing"

- name: start service
  systemd:
    state: started
    name: "{{ services_item }}"
  register: start_service
  failed_when: false

- name: wait
  wait_for:
    timeout: 5
  when:
   - start_service.changed == True
   - start_service.failed == False

- name: status service
  check_systemd:
    action: status
    service_name: "{{ services_item }}"
  register: status_service
  when:
   - start_service.changed == True
   - start_service.failed == False

- name: set results output for services
  include_role:
    name: ips_toolbox_set_results
  vars:
    name: results
    set_results_state: 
      "{% if start_service.msg is defined %}\

          not started\

       {% else %}\

          {% if start_service.changed == True %}\

             {% if status_service.failed == True %}\

                not started\

             {% else %}\

                {% if status_service.status.state != 'started' %}\

                   not started\

                {% else %}\

                   started\

                {% endif %}\

             {% endif %}\

          {% else %}\

             started\

          {% endif %}\

       {% endif %}"
    set_results_item: "{{ services_item }}"
    set_results_value: 
      "{% if start_service.msg is defined %}\

          {{ start_service.msg }}\

       {% else %}\

          {% if start_service.changed == True %}\

             {% if status_service.failed == True %}\

                {{ status_service.msg }}\

             {% endif %}\

          {% endif %}\

       {% endif %}"
    set_results_component: "{{ services_component }}"
    set_results_operation: "{{ services_operation }}"
    set_results_role_name: "{{ services_role_name }}"
    set_results_result_name: "{{ services_result_name }}"
    set_results_status: 
      "{% if start_service.msg is defined %}\

          KO\

       {% else %}\

          {% if start_service.changed == True %}\

             {% if status_service.failed == True %}\

                KO\

             {% else %}\

                OK\

             {% endif %}\

          {% else %}\

             OK
          {% endif %}\

       {% endif %}"


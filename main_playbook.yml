---

- name: "Application Environment Builder"
  hosts: "{{ Hostname | default('all') }}"
  gather_facts: true
  become: true
  serial: 1
  
  vars:
    # Variables de base (collectées via Survey AAP2)
    code_ap: "{{ CodeAP }}"
    code5car: "{{ code5car }}"
    hostname_target: "{{ Hostname }}"
    
    # Variables de reporting et traçabilité
    execution_timestamp: "{{ ansible_date_time.iso8601 }}"
    execution_id: "{{ ansible_date_time.epoch }}"
    report_dir: "/tmp/ansible_reports"
    
    # Configuration universelle (sans distinction d'environnement)
    enable_debug_mode: true
    system_uptime_limit: 90
    dynatrace_required: false
    illumio_enforcement_mode: "enforced"
  
  pre_tasks:
    - name: "Validation des variables obligatoires du Survey AAP2"
      ansible.builtin.assert:
        that:
          - CodeAP is defined and CodeAP != ""
          - code5car is defined and code5car != ""
          - Hostname is defined and Hostname != ""
          - "CodeAP | regex_search('^[0-9]{5}$')"
          - "code5car | regex_search('^[A-Za-z0-9]{5}$')"
        fail_msg: "Variables Survey AAP2 invalides. CodeAP (5 chiffres) et code5car (5 alphanum) requis"
    
    - name: "Création du répertoire de rapports"
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      ignore_errors: true
    
    - name: "Initialisation du rapport d'exécution"
      ansible.builtin.copy:
        content: |
          ================================================================
          RAPPORT D'EXÉCUTION - SHA-TOOLBOX APPLICATION ENVIRONMENT BUILDER
          ================================================================
          Date d'exécution: {{ execution_timestamp }}
          ID d'exécution: {{ execution_id }}
          Serveur cible: {{ Hostname }}
          Code Application: {{ CodeAP }}
          Code 5 caractères: {{ code5car }}
          ================================================================
        dest: "{{ report_dir }}/execution_{{ execution_id }}.log"
        mode: '0644'
      ignore_errors: true

  tasks:
    - name: "Exécution du workflow complet"
      block:
        # ===== PHASE 1 : DÉTECTION ET AUDIT SYSTÈME =====
        - name: "Phase 1 - Détection et audit système"
          block:
            - name: "01 - Mise à jour Facts - Collecte des facts système étendus"
              ansible.builtin.include_role:
                name: app_environment_builder
                tasks_from: detect_os
              tags: [facts, detection]
              ignore_errors: true
            
            - name: "Détection du middleware installé (AVANT création arborescence)"
              ansible.builtin.include_role:
                name: app_environment_builder
                tasks_from: detect_middleware
              tags: [middleware, detection]
              ignore_errors: true
            
            - name: "02 - Banner - Création bannière login"
              ansible.builtin.include_role:
                name: ips_toolbox_banner
              vars:
                banner_operation: "create"
                banner_hostname: "{{ ansible_hostname }}"
                banner_codeAP: "{{ code_ap }}"
                banner_middlewares: "{{ detected_middlewares | default([]) | join(', ') }}"
              tags: [banner]
              ignore_errors: true
            
            - name: "03 - Users - Création d'utilisateurs techniques"
              ansible.builtin.include_role:
                name: ips_toolbox_users
              vars:
                users_operation: "create"
                users_middlewares: "{{ detected_middlewares | default([]) }}"
              tags: [users]
              ignore_errors: true
            
            - name: "03b - Configuration automatique des middlewares détectés"
              ansible.builtin.include_tasks: "{{ playbook_dir }}/roles/app_environment_builder/tasks/configure_detected_middlewares.yml"
              tags: [middleware, config]
              ignore_errors: true
            
            - name: "04 - Toolbox - Vérification interface Toolbox"
              ansible.builtin.include_role:
                name: ips_toolbox_toolboxes
              vars:
                toolboxes_operation: "verify"
              tags: [toolbox]
              ignore_errors: true

        # ===== PHASE 2 : ARBORESCENCE ET FILESYSTEMS =====
        - name: "Phase 2 - Création arborescence et filesystems"
          block:
            - name: "05 - Arborescence - Création /applis + /apps"
              ansible.builtin.include_role:
                name: ips_toolbox_system
              vars:
                system_operation: "create-directory"
                system_codeAP: "{{ code_ap }}"
                system_code5car: "{{ code5car }}"
                system_vgName: "vg_apps"
                system_lvSize: "1024"
                system_iis: "01"
              tags: [arborescence, filesystem]
              ignore_errors: true
            
            - name: "06 - FileSystems - Création automatique"
              ansible.builtin.include_role:
                name: ips_toolbox_system
              vars:
                system_operation: "create-fs"
                system_codeAP: "{{ code_ap }}"
                system_code5car: "{{ code5car }}"
                system_vgName: "vg_apps"
                system_lvSize: "1024"
              tags: [filesystem]
              ignore_errors: true

        # ===== PHASE 3 : VÉRIFICATIONS SYSTÈME =====
        - name: "Phase 3 - Vérifications système et conformité"
          block:
            - name: "07 - Uptime - Vérification et information NTP/Chrony"
              ansible.builtin.include_role:
                name: ips_toolbox_system
              vars:
                system_operation: "uptime"
                system_uptime_limit: "{{ system_uptime_limit }}"
                system_component: "system"
              tags: [uptime, ntp]
              ignore_errors: true
            
            - name: "08 - Dynatrace - Vérification agent (si présent)"
              ansible.builtin.include_role:
                name: ips_toolbox_dynatrace
              vars:
                dynatrace_operation: "check"
              tags: [dynatrace]
              ignore_errors: true
            
            - name: "09 - Illumio - Vérification statut (si présent)"
              ansible.builtin.include_role:
                name: ips_toolbox_illumio
              vars:
                illumio_operation: "check"
              tags: [illumio]
              ignore_errors: true

        # ===== PHASE 4 : SAUVEGARDE ET TSM =====
        - name: "Phase 4 - Configuration sauvegarde"
          block:
            - name: "10 - Sauvegarde - Vérification TSM/Backup (si présent)"
              ansible.builtin.include_role:
                name: ips_toolbox_backup
              vars:
                backup_operation: "check"
                backup_type: "system"
              tags: [backup, tsm]
              ignore_errors: true
            
            - name: "11 - Autosys - Vérification backup applicatif (si présent)"
              ansible.builtin.include_role:
                name: ips_toolbox_autosys
              vars:
                autosys_operation: "check"
              tags: [autosys, backup]
              ignore_errors: true
            
            - name: "12 - Backup système - Vérification complète TSM"
              ansible.builtin.include_role:
                name: ips_toolbox_backup
              vars:
                backup_operation: "check_system"
              tags: [backup]
              ignore_errors: true

        # ===== PHASE 5 : LOGS ET MAINTENANCE =====
        - name: "Phase 5 - Configuration logs et maintenance"
          block:
            - name: "13 - Logs - Configuration purge /applis/logs"
              ansible.builtin.include_role:
                name: ips_toolbox_logs
              vars:
                logs_operation: "setup"
                logs_directory: "/applis/logs"
              tags: [logs, purge]
              ignore_errors: true
      
      rescue:
        - name: "Gestion des erreurs du workflow"
          ansible.builtin.debug:
            msg:
              - "Une erreur s'est produite lors de l'exécution du workflow"
              - "Consultez les logs dans {{ report_dir }}"
      
      always:
        - name: "Création du répertoire de rapports si nécessaire"
          ansible.builtin.file:
            path: "{{ report_dir }}"
            state: directory
            mode: '0755'
          ignore_errors: true
        
        - name: "14 - Génération du récapitulatif final d'exécution"
          ansible.builtin.include_role:
            name: report_generator
          tags: [report, summary]
          ignore_errors: yes
        
        - name: "Finalisation du rapport d'exécution"
          ansible.builtin.lineinfile:
            path: "{{ report_dir }}/execution_{{ execution_id }}.log"
            line: |
              ================================================================
              FIN D'EXÉCUTION: {{ ansible_date_time.iso8601 }}
              ================================================================
            insertafter: EOF
            create: yes
            mode: '0644'
          ignore_errors: true

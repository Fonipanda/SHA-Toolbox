---

- name: "Validation des variables de cr√©ation de filesystems"
  ansible.builtin.assert:
    that:
      - system_codeAP is defined
      - system_codeAP != ""
      - system_code5car is defined
      - system_code5car != ""
      - system_lvSize is defined
    fail_msg: |
      ‚ùå Variables requises manquantes pour cr√©ation FS
      CodeAP: {{ system_codeAP | default('N/A') }}
      Code5car: {{ system_code5car | default('N/A') }}
      LV Size: {{ system_lvSize | default('N/A') }}
    success_msg: |
      ‚úÖ Variables de cr√©ation valides

- name: "V√©rification de la pr√©sence du script Toolbox"
  ansible.builtin.stat:
    path: /apps/toolboxes/exploit/bin/exploit_arbo-app.ksh
  register: tbx_script

- name: "Arr√™t si le script Toolbox est introuvable"
  ansible.builtin.fail:
    msg: "‚ùå Script Toolbox introuvable : /apps/toolboxes/exploit/bin/exploit_arbo-app.ksh"
  when: not tbx_script.stat.exists

- name: "Lecture de la version de la Toolbox"
  ansible.builtin.shell: |
    cat /apps/toolboxes/version | awk -F '|' '{print $2}' | sed 's/\.//g'
  register: tbx_version
  changed_when: false
  failed_when: false

- name: "V√©rification de la version minimale"
  ansible.builtin.assert:
    that:
      - "tbx_version.stdout | int >= 1820"
    fail_msg: |
      ‚ùå Version Toolbox insuffisante : {{ tbx_version.stdout | default('N/A') }}
      Minimum requis : 1820 (v18.2.0)
    success_msg: |
      ‚úÖ Version Toolbox suffisante : {{ tbx_version.stdout }}

- name: "Affichage des param√®tres de cr√©ation"
  ansible.builtin.debug:
    msg:
      - "=== Cr√©ation filesystems via Toolbox ==="
      - "Code Application: {{ system_codeAP }}"
      - "Code 5 caract√®res: {{ system_code5car }}"
      - "Volume Group: {{ system_vgName | default('vg_apps') }}"
      - "Taille LV: {{ system_lvSize }}"

- name: "Cr√©ation des filesystems via script Toolbox"
  ansible.builtin.shell: |
    /apps/toolboxes/exploit/bin/exploit_arbo-app.ksh \
      codeAP={{ system_codeAP }} \
      code5car={{ system_code5car }} \
      {{ 'vg=' + system_vgName if system_vgName is defined else 'vg=vg_apps' }} \
      lv=lv_{{ system_code5car }}:{{ system_lvSize }},lv_{{ system_code5car }}_ti:{{ system_lvSize }},lv_{{ system_code5car }}_to:{{ system_lvSize }},lv_{{ system_code5car }}_tmp:{{ system_lvSize }},lv_{{ system_code5car }}_arch:{{ system_lvSize }}
  register: fs_creation
  ignore_errors: yes
  changed_when: "'-I- Creation du FS' in fs_creation.stdout"

- name: "Affichage du r√©sultat de cr√©ation"
  ansible.builtin.debug:
    msg:
      - "üì¶ R√©sultat cr√©ation FS :"
      - "{{ fs_creation.stdout_lines | default(['Aucune sortie']) }}"

- name: "V√©rification du montage des filesystems"
  ansible.builtin.shell: |
    df -h | grep -E "/applis|/apps" || echo "Aucun FS mont√©"
  register: fs_state
  changed_when: false

- name: "Affichage de l'√©tat des filesystems"
  ansible.builtin.debug:
    msg:
      - "üóÇÔ∏è √âtat des filesystems :"
      - "{{ fs_state.stdout_lines }}"

- name: "Enregistrement du r√©sultat"
  ansible.builtin.include_role:
    name: ips_toolbox_set_results
  vars:
    set_results_state: "{{ 'created' if fs_creation.rc is defined and fs_creation.rc == 0 else 'failed' }}"
    set_results_item: "filesystem"
    set_results_value: "FS {{ system_codeAP }}-{{ system_code5car }}"
    set_results_component: "{{ system_component | default('system') }}"
    set_results_operation: "{{ system_operation | default('create-fs') }}"
    set_results_result_name: "{{ system_result_name | default('create_fs') }}"
    set_results_status: "{{ 'OK' if fs_creation.rc is defined and fs_creation.rc == 0 else 'KO' }}"
  ignore_errors: yes

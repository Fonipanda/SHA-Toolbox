---

- name: "R√©cup√©ration de l'uptime du serveur"
  ansible.builtin.shell: |
    echo $(( ($(date +%s) - $(date -d "$(uptime -s)" +%s)) / 86400 ))
  register: uptime_days_raw
  changed_when: false
  failed_when: false

- name: "Conversion de l'uptime en variable s√©curis√©e"
  ansible.builtin.set_fact:
    uptime_days_count: "{{ uptime_days_raw.stdout | default('0') | int }}"
    uptime_limit_days: 90

- name: "Affichage de l'uptime"
  ansible.builtin.debug:
    msg:
      - "‚è∞ Uptime actuel : {{ uptime_days_count }} jours"
      - "‚è∞ Limite configur√©e : {{ uptime_limit_days }} jours"

- name: "Calcul du statut Uptime"
  ansible.builtin.set_fact:
    uptime_check_status: "{{ 'OK' if (uptime_days_count | int) < (uptime_limit_days | int) else 'WARNING' }}"
    uptime_check_message: "{{ 'Uptime conforme' if (uptime_days_count | int) < (uptime_limit_days | int) else 'Uptime d√©pass√© - Red√©marrage recommand√©' }}"

- name: "Alerte si uptime d√©passe la limite"
  ansible.builtin.debug:
    msg:
      - "‚ö†Ô∏è ATTENTION : Uptime de {{ uptime_days_count }} jours"
      - "‚ö†Ô∏è Limite : {{ uptime_limit_days }} jours"
      - "‚ö†Ô∏è Action recommand√©e : Planifier un red√©marrage"
  when: (uptime_days_count | int) >= (uptime_limit_days | int)

- name: "V√©rification et d√©marrage du service chronyd"
  block:
    - name: "V√©rification du service chronyd (RHEL/CentOS)"
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: yes
      register: chronyd_service
      when: ansible_os_family == "RedHat"
      failed_when: false

    - name: "Affichage du statut chronyd"
      ansible.builtin.debug:
        msg: "üïê Service chronyd : {{ 'actif ‚úÖ' if (chronyd_service.changed is not defined or not chronyd_service.changed) else 'd√©marr√© ‚úÖ' }}"
      when: chronyd_service is defined and not (chronyd_service.failed | default(false))

  rescue:
    - name: "Chronyd non disponible - Ignor√©"
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è Service chronyd non disponible sur ce syst√®me"

- name: "Enregistrement du r√©sultat uptime pour report_generator"
  ansible.builtin.set_fact:
    uptime_final_result:
      uptime_days: "{{ uptime_days_count }}"
      uptime_limit: "{{ uptime_limit_days }}"
      status: "{{ uptime_check_status }}"
      message: "{{ uptime_check_message }}"
      chronyd_active: "{{ (chronyd_service.changed is defined and not chronyd_service.changed) if chronyd_service is defined else false }}"

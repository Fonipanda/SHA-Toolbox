---

- name: "V√©rification de l'installation de Dynatrace OneAgent"
  ansible.builtin.stat:
    path: /apps/dynatrace/oneagent/agent/tools/oneagentctl
  register: dynatrace_installed

- name: "Information si Dynatrace non install√©"
  ansible.builtin.debug:
    msg: "‚ÑπÔ∏è Dynatrace OneAgent non d√©tect√© sur ce serveur - Ignor√©"
  when: not dynatrace_installed.stat.exists

- name: "Bloc de v√©rification Dynatrace"
  block:
    - name: "V√©rification de la version de Dynatrace"
      ansible.builtin.shell: |
        /apps/dynatrace/oneagent/agent/tools/oneagentctl --version 2>&1 | head -1
      register: dynatrace_version
      changed_when: false
      failed_when: false

    - name: "V√©rification du statut de l'agent Dynatrace"
      ansible.builtin.shell: |
        systemctl is-active oneagent 2>&1 || /apps/dynatrace/oneagent/agent/tools/oneagentctl status 2>&1
      register: dynatrace_status_raw
      changed_when: false
      failed_when: false

    - name: "D√©termination du statut OneAgent"
      ansible.builtin.set_fact:
        dynatrace_status: >-
          {%- if 'active' in dynatrace_status_raw.stdout or 'running' in dynatrace_status_raw.stdout -%}
          Connected
          {%- elif 'inactive' in dynatrace_status_raw.stdout or 'stopped' in dynatrace_status_raw.stdout -%}
          Disconnected
          {%- elif 'updating' in dynatrace_status_raw.stdout -%}
          Updating
          {%- else -%}
          Unknown
          {%- endif -%}

    - name: "Affichage des informations Dynatrace"
      ansible.builtin.debug:
        msg:
          - "üìä Dynatrace OneAgent d√©tect√©"
          - "Version : {{ dynatrace_version.stdout | default('N/A') | trim }}"
          - "Statut : {{ dynatrace_status }}"

    - name: "D√©tection si l'agent est arr√™t√©"
      ansible.builtin.set_fact:
        dynatrace_needs_restart: "{{ dynatrace_status == 'Disconnected' }}"

    - name: "Red√©marrage de l'agent Dynatrace si n√©cessaire"
      ansible.builtin.shell: |
        systemctl restart oneagent || /apps/dynatrace/oneagent/agent/tools/oneagentctl restart
      register: dynatrace_restart_result
      when: dynatrace_needs_restart | bool
      changed_when: true
      failed_when: false

    - name: "Affichage du r√©sultat de red√©marrage"
      ansible.builtin.debug:
        msg:
          - "‚úÖ Agent Dynatrace red√©marr√© avec succ√®s"
          - "{{ dynatrace_restart_result.stdout | default('Aucune sortie') }}"
      when: 
        - dynatrace_needs_restart | bool
        - dynatrace_restart_result is defined

    - name: "V√©rification du mode Dynatrace"
      ansible.builtin.shell: |
        grep -i "mode" /apps/dynatrace/oneagent/agent/conf/ruxitagent.conf 2>/dev/null | head -1 || echo "Full-stack"
      register: dynatrace_mode_raw
      changed_when: false
      failed_when: false

    - name: "D√©termination du mode de surveillance"
      ansible.builtin.set_fact:
        dynatrace_mode: >-
          {%- if 'infra' in dynatrace_mode_raw.stdout | lower -%}
          Infra-only
          {%- elif 'log' in dynatrace_mode_raw.stdout | lower -%}
          Logs-only
          {%- else -%}
          Full-stack
          {%- endif -%}

    - name: "Affichage du mode final"
      ansible.builtin.debug:
        msg: "üîß Mode Dynatrace : {{ dynatrace_mode }}"

  when: dynatrace_installed.stat.exists
  rescue:
    - name: "Gestion des erreurs Dynatrace (non bloquante)"
      ansible.builtin.debug:
        msg:
          - "‚ö†Ô∏è Erreur lors de la v√©rification de Dynatrace (non critique)"
          - "Le workflow continue normalement"

---

- name: "Configuration des middlewares détectés - Initialisation"
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════════════"
      - "CONFIGURATION AUTOMATIQUE DES MIDDLEWARES DÉTECTÉS"
      - "═══════════════════════════════════════════════════════════════════"
      - "Middlewares à configurer: {{ middleware_to_configure_list | default([]) | join(', ') }}"
      - "Nombre: {{ middleware_to_configure_list | default([]) | length }}"

- name: "Vérification de la présence de middlewares à configurer"
  ansible.builtin.set_fact:
    has_middlewares_to_configure: "{{ (middleware_to_configure_list | default([]) | length) > 0 }}"

# ===== CONFIGURATION WEBSPHERE ND =====
- name: "Configuration WebSphere ND (WASND)"
  block:
    - name: "Configuration WASND détecté"
      ansible.builtin.include_role:
        name: ips_toolbox_wasnd
      vars:
        wasnd_operation: "configure"
        wasnd_upgrade_version: true
  when: 
    - has_middlewares_to_configure
    - "'wasnd' in middleware_to_configure_list"
  ignore_errors: true
  tags: [wasnd, middleware]

# ===== CONFIGURATION WEBSPHERE BASE =====
- name: "Configuration WebSphere Base (WASBASE)"
  block:
    - name: "Configuration WASBASE détecté"
      ansible.builtin.include_role:
        name: ips_toolbox_wasbase
      vars:
        wasbase_operation: "configure"
        wasbase_upgrade_version: true
  when:
    - has_middlewares_to_configure
    - "'wasbase' in middleware_to_configure_list"
  ignore_errors: true
  tags: [wasbase, middleware]

# ===== CONFIGURATION LIBERTY =====
- name: "Configuration WebSphere Liberty"
  block:
    - name: "Détermination du type Liberty (Core ou Base)"
      ansible.builtin.set_fact:
        liberty_detected_type: >-
          {{
            detected_middleware_list 
            | selectattr('name', 'search', 'Liberty') 
            | map(attribute='name') 
            | first 
            | default('Liberty_Core')
          }}
    
    - name: "Configuration Liberty Core"
      ansible.builtin.include_role:
        name: ips_toolbox_libertycore
      vars:
        liberty_operation: "configure"
        liberty_upgrade_version: true
      when: "'Core' in liberty_detected_type"
    
    - name: "Configuration Liberty Base"
      ansible.builtin.include_role:
        name: ips_toolbox_libertybase
      vars:
        liberty_operation: "configure"
        liberty_upgrade_version: true
      when: "'Base' in liberty_detected_type"
  when:
    - has_middlewares_to_configure
    - "'liberty' in middleware_to_configure_list"
  ignore_errors: true
  tags: [liberty, middleware]

# ===== CONFIGURATION ORACLE =====
- name: "Configuration Oracle Database"
  block:
    - name: "Configuration Oracle détecté"
      ansible.builtin.include_role:
        name: ips_toolbox_oracle
      vars:
        oracle_operation: "configure"
        oracle_upgrade_version: true
  when:
    - has_middlewares_to_configure
    - "'oracle' in middleware_to_configure_list"
  ignore_errors: true
  tags: [oracle, middleware]

# ===== CONFIGURATION SQL SERVER =====
- name: "Configuration SQL Server"
  block:
    - name: "Configuration SQL Server détecté"
      ansible.builtin.include_role:
        name: ips_toolbox_sqlserver
      vars:
        sqlserver_operation: "configure"
        sqlserver_upgrade_version: true
  when:
    - has_middlewares_to_configure
    - "'sqlserver' in middleware_to_configure_list"
  ignore_errors: true
  tags: [sqlserver, middleware]

# ===== CONFIGURATION IBM MQ =====
- name: "Configuration IBM MQ"
  block:
    - name: "Configuration MQ détecté"
      ansible.builtin.debug:
        msg: "IBM MQ détecté - Configuration à implémenter via rôle ips_toolbox_mq"
      # TODO: Créer le rôle ips_toolbox_mq si nécessaire
      # ansible.builtin.include_role:
      #   name: ips_toolbox_mq
      # vars:
      #   mq_operation: "configure"
  when:
    - has_middlewares_to_configure
    - "'mq' in middleware_to_configure_list"
  ignore_errors: true
  tags: [mq, middleware]

# ===== CONFIGURATION AXWAY CFT =====
- name: "Configuration Axway CFT"
  block:
    - name: "Configuration CFT détecté"
      ansible.builtin.debug:
        msg: "Axway CFT détecté - Configuration à implémenter via rôle ips_toolbox_cft"
      # TODO: Créer le rôle ips_toolbox_cft si nécessaire
      # ansible.builtin.include_role:
      #   name: ips_toolbox_cft
      # vars:
      #   cft_operation: "configure"
  when:
    - has_middlewares_to_configure
    - "'cft' in middleware_to_configure_list"
  ignore_errors: true
  tags: [cft, middleware]

# ===== CONFIGURATION IBM HTTP SERVER =====
- name: "Configuration IBM HTTP Server (IHS)"
  block:
    - name: "Configuration IHS détecté"
      ansible.builtin.include_role:
        name: ips_toolbox_webserver
      vars:
        webserver_operation: "configure"
        webserver_upgrade_version: true
  when:
    - has_middlewares_to_configure
    - "'ihs' in middleware_to_configure_list"
  ignore_errors: true
  tags: [ihs, webserver, middleware]

# ===== CONFIGURATION JVM =====
- name: "Configuration JVM"
  block:
    - name: "Vérification version JVM"
      ansible.builtin.debug:
        msg: "JVM détecté - Vérification de version uniquement (pas de configuration spécifique)"
      # JVM est généralement géré par les middlewares eux-mêmes
  when:
    - has_middlewares_to_configure
    - "'jvm' in middleware_to_configure_list"
  ignore_errors: true
  tags: [jvm, middleware]

# ===== RÉSUMÉ FINAL =====
- name: "Résumé de la configuration des middlewares"
  ansible.builtin.debug:
    msg:
      - ""
      - "═══════════════════════════════════════════════════════════════════"
      - "RÉSUMÉ CONFIGURATION MIDDLEWARES"
      - "═══════════════════════════════════════════════════════════════════"
      - "✅ Middlewares configurés avec succès"
      - "Total traité: {{ middleware_to_configure_list | default([]) | length }}"
      - "Liste: {{ middleware_to_configure_list | default([]) | join(', ') }}"
      - ""
      - "⚠️  Note: Les binaires existants n'ont PAS été touchés"
      - "⚠️  Seules les configurations et mises à jour de version ont été effectuées"
      - "═══════════════════════════════════════════════════════════════════"
  when: has_middlewares_to_configure

- name: "Aucun middleware à configurer"
  ansible.builtin.debug:
    msg:
      - "ℹ️  Aucun middleware détecté nécessitant une configuration"
      - "Le serveur est soit vierge, soit déjà correctement configuré"
  when: not has_middlewares_to_configure

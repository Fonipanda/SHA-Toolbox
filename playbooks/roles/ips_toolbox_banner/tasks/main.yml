---

- name: "Initialisation du rôle banner"
  ansible.builtin.set_fact:
    banner_component: "banner"
    banner_operation: "{{ banner_operation | default('create') }}"
    banner_company_name: "{{ banner_company_name | default('Entreprise') }}"

- name: "Récupération du Serial Number via dmidecode"
  ansible.builtin.shell: |
    dmidecode -s system-serial-number 2>/dev/null | head -1 | grep -v '^#' || echo "{{ ansible_product_serial | default('Unknown') }}"
  register: system_serial_number
  changed_when: false
  failed_when: false
  when: ansible_os_family != "Windows"

- name: "Enregistrement du Serial Number"
  ansible.builtin.set_fact:
    banner_serial_number: "{{ system_serial_number.stdout | trim if system_serial_number is defined and system_serial_number.stdout is defined else ansible_product_serial | default('Unknown') }}"

- name: "Création d'un prompt shell simple et propre (chargé en dernier)"
  ansible.builtin.copy:
    dest: /etc/profile.d/zzz_clean_prompt.sh
    mode: '0644'
    owner: root
    group: root
    content: |
      # Prompt simple et propre - chargé en DERNIER (zzz_ prefix)
      # Généré par SHA-Toolbox - Écrase tous les autres PS1
      if [ "$PS1" ]; then
        export PS1='$ '
      fi
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Recherche et suppression des PS1 avec codes ANSI dans /etc/bashrc"
  ansible.builtin.shell: |
    if grep -q '033\[' /etc/bashrc 2>/dev/null; then
      cp /etc/bashrc /etc/bashrc.bak
      sed -i '/033\[/d' /etc/bashrc
      echo "CLEANED"
    else
      echo "NOTHING_TO_CLEAN"
    fi
  register: bashrc_cleanup
  changed_when: "'CLEANED' in bashrc_cleanup.stdout"
  failed_when: false
  when: ansible_os_family != "Windows"

- name: "Recherche et suppression des PS1 avec codes ANSI dans /etc/profile"
  ansible.builtin.shell: |
    if grep -q '033\[' /etc/profile 2>/dev/null; then
      cp /etc/profile /etc/profile.bak
      sed -i '/033\[/d' /etc/profile
      echo "CLEANED"
    else
      echo "NOTHING_TO_CLEAN"
    fi
  register: profile_cleanup
  changed_when: "'CLEANED' in profile_cleanup.stdout"
  failed_when: false
  when: ansible_os_family != "Windows"

- name: "Recherche des fichiers profile.d contenant codes ANSI"
  ansible.builtin.find:
    paths: /etc/profile.d
    patterns: "*.sh"
    contains: '033\['
  register: profile_d_files_with_ansi
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Nettoyage des codes ANSI dans profile.d"
  ansible.builtin.shell: |
    cp "{{ item.path }}" "{{ item.path }}.bak"
    sed -i '/033\[/d' "{{ item.path }}"
  loop: "{{ profile_d_files_with_ansi.files }}"
  when: 
    - ansible_os_family != "Windows"
    - profile_d_files_with_ansi.files is defined
    - profile_d_files_with_ansi.files | length > 0
  ignore_errors: true

- name: "Formatage des middlewares pour la bannière"
  ansible.builtin.set_fact:
    banner_middlewares_formatted: "{% if detected_middleware_list | default([]) | length > 0 %}{{ detected_middleware_list | map(attribute='name') | join(', ') }}{% else %}Aucun{% endif %}"
    banner_middlewares_with_versions: "{% if detected_middleware_list | default([]) | length > 0 %}{% for mw in detected_middleware_list %}{{ mw.name }} {{ mw.version | regex_replace('\\n.*', '') | trim }}{{ ', ' if not loop.last else '' }}{% endfor %}{% else %}Aucun{% endif %}"

- name: "Création de la bannière PRÉ-LOGIN pour issue (console locale)"
  ansible.builtin.template:
    src: infos_pre_login.j2
    dest: /etc/issue
    mode: '0644'
    owner: root
    group: root
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Création de la bannière PRÉ-LOGIN pour issue.net (SSH)"
  ansible.builtin.template:
    src: infos_pre_login.j2
    dest: /etc/issue.net
    mode: '0644'
    owner: root
    group: root
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Création de la bannière POST-LOGIN (MOTD)"
  ansible.builtin.template:
    src: infos_post_login.j2
    dest: /etc/motd
    mode: '0644'
    owner: root
    group: root
  ignore_errors: true

- name: "Configuration SSH pour afficher la bannière PRÉ-LOGIN"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/issue.net'
    backup: yes
  notify: restart sshd
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Désactivation de PrintLastLog dans SSH (Last login géré par PAM)"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PrintLastLog'
    line: 'PrintLastLog yes'
    backup: yes
  notify: restart sshd
  ignore_errors: true
  when: ansible_os_family != "Windows"

- name: "Affichage du statut de création des bannières"
  ansible.builtin.debug:
    msg:
      - "✅ Bannières créées pour {{ ansible_hostname }}"
      - "   • PRÉ-LOGIN (/etc/issue.net): Disclaimer uniquement"
      - "   • POST-LOGIN (/etc/motd): Informations système complètes"
      - "   • PROMPT: Nettoyé et simplifié ($ sans codes ANSI)"
      - "Type: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "Virtualisation: {{ ansible_virtualization_type | default('physical') }}"
      - "Serial Number: {{ banner_serial_number }}"
      - "Application: {{ banner_codeAP | default('N/A') }}"
      - "Middlewares détectés: {{ banner_middlewares_formatted | default('Aucun') }}"
      - "Middlewares avec versions: {{ banner_middlewares_with_versions | default('Aucun') }}"
